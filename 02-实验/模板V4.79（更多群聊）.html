<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[在此处填写报告标题] - [日期]</title>
    <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5rLesXWW/sGuLhYFChxgYnz2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script>
    <style>
        /* CSS变量定义 */
        :root {
            /* 主题颜色配置 */
            --bg-primary: #F5F5EE; /* 主背景色 - 米白色 */
            --bg-secondary: #faf9f6; /* 次背景色 - 卡片背景 */
            --bg-tertiary: #f1f3f5; /* 第三背景色 - 标签等 */
            --text-primary: #212529; /* 主要文字颜色 */
            --text-secondary: #495057; /* 次要文字颜色 */
            --accent-primary: #FB651E; /* 主要强调色 - 橙色 */
            --accent-secondary: #ff8906; /* 次要强调色 */
            --accent-tertiary: #e8590c; /* 第三强调色 */
            --accent-blue: #007EFF;     /* 蓝色强调 */
            --accent-purple: #7048e8; /* 紫色强调 */
            --accent-cyan: #10B981;     /* 青色强调 */
            --highlight-keyword-bg: #ffe8cc; /* 关键词高亮背景 */
            --highlight-name-color: #7048e8; /* 人名高亮颜色 */

            /* 布局与样式变量 */
            --card-padding: 24px; /* 卡片内边距 */
            --grid-gap: 16px; /* 网格间距 */
            --card-radius: 12px; /* 卡片圆角 */
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* 卡片阴影 */
            --font-family: 'Inter', 'SF Pro Display', 'Segoe UI', sans-serif; /* 字体栈 */

            /* KityMinder自定义主题颜色 */
            --km-orange: #FB651E;     /* KityMinder橙色，用于一级节点 */
            --km-blue: #007EFF;       /* KityMinder蓝色，用于二级节点 */
            --km-lightblue: #10B981;  /* KityMinder浅蓝色，用于三级节点 */
            --km-root-bg: #f0f0f0;     /* KityMinder根节点背景 */
            --km-root-stroke: var(--km-root-bg); /* KityMinder根节点边框 */
            --km-root-text: #333333;   /* KityMinder根节点文字颜色 */
            --km-node-text: #ffffff;   /* KityMinder普通节点文字颜色 */
            --km-connect-color: #777777; /* KityMinder连接线颜色 */
        }

        /* 全局重置和基础样式 */
        * {
            margin: 0; /* 清除外边距 */
            padding: 0; /* 清除内边距 */
            box-sizing: border-box; /* 使用border-box盒模型 */
        }

        body {
            font-family: var(--font-family); /* 应用定义的字体栈 */
            background-color: var(--bg-primary); /* 设置页面背景色 */
            color: var(--text-primary); /* 设置主要文字颜色 */
            line-height: 1.6; /* 设置行高 */
            font-size: 16px; /* 设置基础字号 */
            width: 100%; /* 页面宽度占满父容器 */
            max-width: 1000px; /* 内容最大宽度 */
            margin: 0 auto; /* 内容居中显示 */
            padding: 20px; /* 页面内边距 */
        }
        body.modal-active { /* 当模态框激活时，禁止页面滚动 */
            overflow: hidden;
        }

        /* 标题样式 */
        h1, h2, h3, h4 {
            font-weight: 600; /* 标题字重 */
            letter-spacing: 0.5px; /* 字符间距 */
        }

        h1 { /* 主标题样式 */
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
        }

        h2 { /* 二级标题样式 */
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        h3 { /* 三级标题样式 */ /* This is a general h3 style, specific card h3s might override or use Tailwind */
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--accent-blue);
        }
        
        /*网格容器布局 */
        .grid-container {
            display: grid; /* 使用CSS Grid布局 */
            grid-template-columns: repeat(12, 1fr); /* 12列网格系统 */
            grid-auto-rows: minmax(100px, auto); /* 行高自动调整，最小100px */
            gap: var(--grid-gap); /* 网格间距 */
            margin-top: 20px; /* 与上方元素的间距 */
            /* 网格区域定义 */
            grid-template-areas:
                "main       main       main       main       main       main       main       main       main       main       main       main"
                "intro      intro      intro      intro      intro      intro      intro      intro      intro      intro      intro      intro"
                "topics     topics     topics     topics     topics     topics     topics     topics     topics     topics     topics     topics"
                "mindmap    mindmap    mindmap    mindmap    mindmap    mindmap    mindmap    mindmap    mindmap    mindmap    mindmap    mindmap"
                "quote      quote      quote      quote      quote      quote      links      links      links      links      links      links"
                "bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row bottom_row"
                "more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro more_groups_intro"
                "qrcode     qrcode     qrcode     qrcode     qrcode     qrcode     qrcode     qrcode     qrcode     qrcode     qrcode     qrcode";
        }

        /* 卡片通用样式 */
        .card {
            background-color: var(--bg-secondary); /* 卡片背景色 */
            border-radius: var(--card-radius); /* 卡片圆角 */
            padding: var(--card-padding); /* 卡片内边距 */
            box-shadow: var(--card-shadow); /* 卡片阴影 */
            position: relative; /* 用于绝对定位子元素 */
            overflow: hidden; /* 防止内容溢出圆角 */
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* 过渡动画 */
            display: flex; /* 使用flex布局 */
            flex-direction: column; /* flex子元素垂直排列 */
        }

        .card:hover { /* 卡片悬停效果 */
            transform: translateY(-5px); /* 轻微上浮 */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); /* 增强阴影 */
        }

        .card::before { /* 卡片顶部装饰条 */
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-primary);
        }

        .card-icon { /* 卡片右下角装饰图标 */
            position: absolute;
            bottom: var(--card-padding);
            right: var(--card-padding);
            font-size: 4rem; /* 图标大小 */
            opacity: 0.07; /* 图标透明度 */
            color: var(--accent-primary); /* 图标颜色 */
            z-index: 0; /*确保在内容下方*/
        }

        /* 网格区域分配 */
        .main-card { grid-area: main; }
        .group-intro-card { grid-area: intro; }
        .topic-cards-wrapper {
            grid-area: topics;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--grid-gap);
        }
        .mindmap-card-container { grid-area: mindmap; }
        .quote-card { grid-area: quote; }
        .links-card { grid-area: links; }
        .stats-wordcloud-row {
            grid-area: bottom_row;
            display: flex;
            gap: var(--grid-gap);
            align-items: stretch;
        }
        .more-groups-intro-card { grid-area: more_groups_intro; }
        .qr-code-container-card { grid-area: qrcode; }


        .stats-card {
            flex-grow: 7;
            flex-shrink: 1;
            flex-basis: 0;
            min-width: 0;
        }
        .wordcloud-card {
            flex-grow: 5;
            flex-shrink: 1;
            flex-basis: 0;
            min-width: 0;
            max-width: 50%;
        }

        /* 主题卡片样式 */
        .topic-card {
            grid-column: span 6;
            min-height: 250px;
        }
        .topic-card > .topic-card-content-wrapper {
            flex-grow: 1;
            padding-bottom: 1rem;
        }
        .topic-cards-wrapper > .topic-card:nth-last-child(1):nth-child(odd) {
            grid-column: span 12;
        }

        /* 主卡片内部元素样式 */
        .main-card h1 { text-align: center; }
        .main-card .date { text-align: center; }
        .date { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .meta-info { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 1rem; justify-content: center; }
        .meta-info span { background-color: var(--bg-tertiary); padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; color: var(--accent-blue); }
        .summary { margin-top: 1rem; line-height: 1.7; text-align: left; }

        .group-intro-card h2 i { margin-right: 8px; }
        .group-intro-card p { margin-bottom: 1rem; }
        .group-intro-card h3 i { margin-right: 8px; }
        
        /* Styles for the new "More Group Chats Intro Card" */
        .more-groups-intro-card .group-section {
            border-bottom-width: 1px; /* Tailwind: border-b */
            border-color: #e5e7eb; /* Tailwind: border-gray-200 */
            padding-bottom: 1.5rem; /* Tailwind: pb-6 */
            margin-bottom: 1.5rem; /* Tailwind: mb-6 */
        }
        .more-groups-intro-card .group-section:last-child {
            border-bottom-width: 0;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        /* The h3 inside .more-groups-intro-card will use Tailwind classes directly from the new content */


        .topic-category { display: inline-block; background-color: var(--accent-tertiary); color: var(--bg-primary); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 0.5rem; }
        .topic-keywords { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 0.75rem; margin-bottom: 0.75rem; }
        .keyword { background-color: var(--bg-tertiary); color: var(--accent-primary); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .highlight-keyword { background-color: var(--highlight-keyword-bg); padding: 1px 2px; border-radius: 2px; font-weight: 500; display: inline; line-height: 1.2; box-decoration-break: clone; -webkit-box-decoration-break: clone; }
        .highlight-name { color: var(--highlight-name-color); font-weight: 500; }
        .topic-mentions { font-size: 0.9rem; color: var(--text-secondary); }

        .quote { position: relative; padding-left: 20px; margin: 10px 0; font-style: italic; color: var(--text-secondary); }
        .quote::before { content: '"'; position: absolute; left: 0; top: 0; font-size: 1.5rem; color: var(--accent-tertiary); }
        .quote-author { text-align: right; font-size: 0.9rem; color: var(--accent-tertiary); margin-top: 5px; }

        .link-item { display: flex; align-items: center; margin-bottom: 10px; padding: 8px; border-radius: 6px; background-color: var(--bg-tertiary); transition: background-color 0.2s ease; text-decoration: none; }
        .link-item:hover { background-color: rgba(0, 123, 255, 0.1); }
        .link-item a { text-decoration: none; color: inherit; display: flex; align-items: center; width: 100%; }
        .link-item a:hover .link-title { text-decoration: underline; color: var(--accent-blue); }
        .link-icon { margin-right: 10px; color: var(--accent-blue); }
        .link-title { flex-grow: 1; color: var(--text-primary); }
        .link-title.is-link { color: var(--accent-blue); }
        .link-title.is-link:hover { text-decoration: underline; }

        .user-stats-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        .user-stats-table th { text-align: center; padding: 0.75rem 0.5rem; border-bottom: 2px solid var(--accent-primary); color: var(--text-primary); font-weight: 600; font-size: 0.9rem; }
        .user-stats-table td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--bg-tertiary); color: var(--text-secondary); font-size: 0.85rem; vertical-align: top; text-align: left; }
        .user-stats-table .user-name-col { width: 25%; font-weight: 500; word-break: break-all; }
        .user-stats-table .message-count-col { text-align: center; width: 15%; white-space: nowrap; }
        .user-stats-table .contribution-col { width: 60%; word-break: break-all; }
        .user-stats-table tr:last-child td { border-bottom: none; }

        .wordcloud { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 20px 0; }
        .wordcloud-item { padding: 5px 10px; border-radius: 4px; font-weight: 500; transition: transform 0.2s ease; }
        .wordcloud-item:hover { transform: scale(1.1); }
        .size-1 { font-size: 0.9rem; color: var(--text-secondary); }
        .size-2 { font-size: 1.1rem; color: var(--accent-cyan); }
        .size-3 { font-size: 1.3rem; color: var(--accent-blue); }
        .size-4 { font-size: 1.5rem; color: var(--accent-purple); }
        .size-5 { font-size: 1.8rem; color: var(--accent-tertiary); }

        .qr-code-container-card h2 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: var(--accent-primary);
            text-align: center;
            font-weight: 600;
        }
        .qr-code-container-card h2 i { margin-right: 0.5rem; }
        .qr-code-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: var(--grid-gap, 16px);
            padding: 10px 0;
        }
        .qr-code-item {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            flex: 0 0 130px;
            height: 130px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .qr-code-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .qr-code-item img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }
        .qr-code-item span {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: auto;
        }

        /* 操作按钮区域样式 */
        .action-buttons-container {
            display: flex; /* Always use flex */
            flex-wrap: nowrap; /* Always keep buttons on one line */
            justify-content: center; /* Center the group of buttons */
            gap: 10px; /* Space between buttons */
            margin: 20px 0;
            padding-bottom: 20px; /* Existing padding */
            overflow-x: auto; /* Allow horizontal scrolling if buttons overflow */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: var(--accent-secondary) var(--bg-tertiary); /* For Firefox */
        }
        /* Style for Webkit scrollbars (Chrome, Safari, Edge) */
        .action-buttons-container::-webkit-scrollbar {
            height: 8px; /* Height of horizontal scrollbar */
        }
        .action-buttons-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .action-buttons-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-secondary);
            border-radius: 4px;
            border: 2px solid var(--bg-tertiary); /* Creates padding around thumb */
        }
        .action-buttons-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-primary);
        }

        .action-button {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--card-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: var(--card-shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }
        .action-button:hover { background-color: var(--accent-secondary); transform: translateY(-2px); }
        .action-button i, .action-button .fas { margin-right: 8px; }

        .footer { margin-top: 30px; text-align: center; color: var(--text-secondary); font-size: 0.9rem; }
        #report-content-wrapper .footer { margin-top: 30px; padding-bottom: 20px; }

        .mindmap-card {}
        .mindmap-card h2 i { margin-right: 8px; }
        .mindmap-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .mindmap-controls button { background-color: var(--km-blue); color: white; border: none; padding: 8px 12px; border-radius: var(--card-radius); font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; }
        .mindmap-controls button:hover { background-color: #005bb5; }
        .mindmap-controls button i { margin-right: 5px; }
        .mindmap-controls .fullscreen-toggle-btn { margin-left: auto; }

        .kityminder-container {
            flex-grow: 1;
            overflow: hidden;
            background-color: #fff;
            border-radius: 8px;
            padding: 0;
            border: 1px solid var(--bg-tertiary);
            min-height: 400px;
            position: relative;
            transition: height 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kityminder-container:empty::before {
            content: "思维导图加载中或内容为空...";
            color: var(--text-secondary); font-style: italic; text-align: center;
            padding: 20px; display: flex; justify-content: center; align-items: center;
            height: 100%; min-height: 150px;
        }

        #mermaid-main-feedback-message, #mermaid-modal-feedback-message {
            text-align: center; margin-top: 15px; padding: 8px; border-radius: 4px;
            font-weight: 500; font-size: 0.9rem; display: none;
        }
        #mermaid-main-feedback-message.success, #mermaid-modal-feedback-message.success {
            color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; display: block;
        }
        #mermaid-main-feedback-message.error, #mermaid-modal-feedback-message.error {
            color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; display: block;
        }
        #mermaid-main-feedback-message.info, #mermaid-modal-feedback-message.info {
            color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; display: block;
        }

        #feedback-message { text-align: center; margin-top: 10px; font-weight: 500; }
        #feedback-message.success { color: green; }
        #feedback-message.error { color: red; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); display: none;
            justify-content: center; align-items: center; z-index: 1000; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            width: 95%; height: 90%; max-width: 1200px;
        }
        .modal-close-btn {
            position: absolute; top: 15px; right: 20px; background: none; border: none;
            font-size: 2.2rem; color: var(--text-secondary); cursor: pointer;
            line-height: 1; padding: 5px; z-index: 1010;
        }
        .modal-close-btn:hover { color: var(--text-primary); }
        #modalKityMinderContainer {
            flex-grow: 1; min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card { animation: fadeIn 0.5s ease forwards; }
        .main-card { animation-delay: 0.1s; }
        .group-intro-card { animation-delay: 0.2s; }
        .topic-cards-wrapper .topic-card:nth-child(1) { animation-delay: 0.3s; }
        .topic-cards-wrapper .topic-card:nth-child(2) { animation-delay: 0.4s; }
        .topic-cards-wrapper .topic-card:nth-child(3) { animation-delay: 0.5s; }
        .topic-cards-wrapper .topic-card:nth-child(4) { animation-delay: 0.6s; }
        .mindmap-card-container .card { animation-delay: 0.7s; }
        .quote-card { animation-delay: 0.8s; }
        .links-card { animation-delay: 0.9s; }
        .stats-wordcloud-row { animation: fadeIn 0.5s ease forwards; animation-delay: 1.0s; }
        .more-groups-intro-card { animation-delay: 1.1s; }
        .qr-code-container-card { animation: fadeIn 0.5s ease forwards; animation-delay: 1.2s; }
        #report-content-wrapper .footer { animation: fadeIn 0.5s ease forwards; animation-delay: 1.3s; }
        .action-buttons-container { animation: fadeIn 0.5s ease forwards; animation-delay: 1.4s; }

        @media (max-width: 768px) {
            body { padding: 10px; font-size: 14px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.1rem; }
            /* H3 inside the new card will use Tailwind classes, so this general h3 might not apply or might conflict.
               The Tailwind classes like text-2xl (1.5rem) on the new h3s will take precedence.
            */

            .grid-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "main"
                    "intro"
                    "topics"
                    "mindmap"
                    "quote"
                    "links"
                    "bottom_row"
                    "more_groups_intro"
                    "qrcode";
            }
            .stats-wordcloud-row { flex-direction: column; }
            .stats-wordcloud-row > .card { width: 100%; flex-basis: auto !important; max-width: none; }
            .topic-cards-wrapper { grid-template-columns: 1fr; }
            .topic-card { grid-column: 1 / -1; min-height: auto; }
            .topic-card > .topic-card-content-wrapper { padding-bottom: 1rem; }
            .topic-mentions { position: static; margin-top: 10px; margin-bottom: 10px; text-align: left; }
            .card-icon { font-size: 2.5rem; opacity:0.05; }
            .mindmap-card .card-icon { bottom: 15px; right: 15px; }
            .user-stats-table th, .user-stats-table td { padding: 0.5rem 0.25rem; font-size: 0.8rem; }
            .user-stats-table td { text-align: left; }
            .user-stats-table .message-count-col { text-align: center; }
            
            .action-button { padding: 8px 15px; font-size: 0.9rem; }

            .mindmap-card-container .card { padding: 15px; }
            .mindmap-controls button { font-size: 0.8rem; padding: 6px 10px; }
            .modal-content { width: 100%; height: 95%; padding:15px; }
            .modal-close-btn { font-size: 1.8rem; top:10px; right:10px;}

            .qr-code-container-card h2 { font-size: 1.4rem; margin-bottom: 1rem; }
            .qr-code-grid { gap: 12px; }
            .qr-code-item { flex-basis: calc(50% - 6px); height: auto; aspect-ratio: 1/1; padding: 0.75rem; }
            .qr-code-item img { width: 70%; height: 70%; max-width: 80px; max-height: 80px; margin-bottom: 0.3rem; }
            .qr-code-item span { font-size: 0.7rem; }
        }

        @media (max-width: 480px) {
            .user-stats-table { display: block; overflow-x: auto; }
            .user-stats-table th, .user-stats-table td { white-space: normal; }
            .user-stats-table thead, .user-stats-table tbody, .user-stats-table tr { display: block; }
            .user-stats-table tr { border-bottom: 1px solid var(--bg-tertiary); }
            .user-stats-table th { display: none; }
            .user-stats-table td { display: block; text-align: left; border-bottom: none; padding-left: 0.5rem; }
            .user-stats-table td.message-count-col { text-align: left; }
            .user-stats-table td::before { content: attr(data-label); font-weight: bold; display: inline-block; width: 100px; margin-right: 10px; color: var(--text-primary); text-align: left; }
            .user-stats-table tr:last-child { border-bottom: none; }

            .qr-code-item { flex-basis: calc(50% - 6px); }
            .qr-code-item img { width: 60%; height: 60%; max-width: 70px; max-height: 70px; }
            .qr-code-item span { font-size: 0.65rem; }
        }
    </style>
</head>
<body>
    <div id="report-content-wrapper"> <div class="grid-container">
            <div class="card main-card">
                <h1 contenteditable="false">[主报告标题 - 例如：AI产品团日报]</h1>
                <div class="date">[日期 - 例如：2025年5月19日]</div>
                <div class="meta-info">
                    <span><i class="fas fa-comment"></i> 消息数: [数字]+</span>
                    <span><i class="fas fa-users"></i> 活跃用户: [数字]+</span>
                    <span><i class="fas fa-fire"></i> 热点话题: [数字]</span>
                </div>
                <p class="summary">[在此处填写当日讨论的总体摘要。保持简洁明了，突出群组的主要主题和氛围。]</p>
                <i class="fas fa-microchip card-icon"></i>
            </div>

            <div class="card group-intro-card">
                <h2><i class="fas fa-info-circle"></i> 群聊概况</h2>
                <p>AI产品蝗虫团是一个专注于AI产品前沿探索和深度实践的高质量技术社群。群内汇聚了众多AI产品爱好者、技术专家和创业者，形成了独特的“蝗虫”文化——对新AI工具保持极高敏感度，快速发现、测试并分享最新的AI产品和技术。</p>
                <div style="margin-top: 1rem;">
                    <h3 style="font-size: 1.1rem; color: var(--accent-secondary); margin-bottom: 0.5rem;"><i class="fas fa-bug"></i> “蝗虫”文化核心特点：</h3>
                    <ul style="list-style-type: none; padding-left: 0;">
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center;"><i class="fas fa-tachometer-alt fa-fw" style="color: var(--accent-primary); margin-right: 8px;"></i> <strong>前沿敏感：</strong>对新AI工具和技术保持极高敏感度。</li>
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center;"><i class="fas fa-bolt fa-fw" style="color: var(--accent-primary); margin-right: 8px;"></i> <strong>快速行动：</strong>快速发现、测试最新AI产品。</li>
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center;"><i class="fas fa-bullhorn fa-fw" style="color: var(--accent-primary); margin-right: 8px;"></i> <strong>积极分享：</strong>第一时间分享邀请码、使用体验和技术洞察。</li>
                    </ul>
                </div>
            </div>

            <div class="topic-cards-wrapper">
                <div class="card topic-card">
                    <div class="topic-card-content-wrapper">
                        <h2 contenteditable="false"><i class="fas fa-lightbulb"></i> [主题1标题]</h2>
                        <div class="topic-category">[分类1 - 例如：工具技巧]</div>
                        <p>关于<span class="highlight-keyword">插件功能</span>的讨论，特别是<span class="highlight-name">@用户A</span>提到的<span class="highlight-keyword">上下文处理</span>能力。</p>
                        <div class="topic-keywords">
                            <span class="keyword">[关键词1A]</span>
                            <span class="keyword">[关键词1B]</span>
                            <span class="keyword">[关键词1C]</span>
                        </div>
                        <div class="topic-mentions"><i class="fas fa-bullhorn"></i> 提及次数: [数量1]</div>
                    </div>
                    <i class="fas fa-tools card-icon"></i>
                </div>
                <div class="card topic-card">
                     <div class="topic-card-content-wrapper">
                        <h2 contenteditable="false"><i class="fas fa-rocket"></i> [主题2标题]</h2>
                        <div class="topic-category">[分类2 - 例如：新功能]</div>
                        <p><span class="highlight-name">@用户B</span>分享了<span class="highlight-keyword">AI搜索</span>的最新进展和<span class="highlight-keyword">地区限制</span>问题。</p>
                        <div class="topic-keywords">
                            <span class="keyword">[关键词2A]</span>
                            <span class="keyword">[关键词2B]</span>
                        </div>
                        <div class="topic-mentions"><i class="fas fa-bullhorn"></i> 提及次数: [数量2]</div>
                    </div>
                    <i class="fas fa-star card-icon"></i>
                </div>
                <div class="card topic-card">
                    <div class="topic-card-content-wrapper">
                        <h2 contenteditable="false"><i class="fas fa-comments-dollar"></i> [主题3标题]</h2>
                        <div class="topic-category">[分类3 - 例如：工具体验]</div>
                        <p>大家对<span class="highlight-keyword">Agent技术</span>的<span class="highlight-keyword">商业化前景</span>进行了探讨，<span class="highlight-name">@用户C</span>提出了独到见解。</p>
                        <div class="topic-keywords">
                            <span class="keyword">[关键词3A]</span>
                            <span class="keyword">[关键词3B]</span>
                            <span class="keyword">[关键词3C]</span>
                        </div>
                        <div class="topic-mentions"><i class="fas fa-bullhorn"></i> 提及次数: [数量3]</div>
                    </div>
                    <i class="fas fa-comments card-icon"></i>
                </div>
            </div>

            <div class="mindmap-card-container card">
                <div class="mindmap-card">
                    <h2><i class="fas fa-sitemap"></i> 核心概念关系图</h2>
                    <div class="mindmap-controls">
                        <button id="zoomInBtn"><i class="fas fa-search-plus"></i> 放大</button>
                        <button id="zoomOutBtn"><i class="fas fa-search-minus"></i> 缩小</button>
                        <button id="downloadDiagramBtn"><i class="fas fa-download"></i> 下载 SVG</button>
                        <button id="fullscreenOpenBtn" class="fullscreen-toggle-btn"><i class="fas fa-expand"></i> 全屏</button>
                    </div>
                    <div class="kityminder-container" id="mainKityMinderContainer"></div>
                    <div id="mermaid-main-feedback-message"></div>
                    <i class="fas fa-project-diagram card-icon"></i>
                </div>
            </div>

            <div class="card quote-card">
                <h2 contenteditable="false"><i class="fas fa-quote-left"></i> 精彩引用</h2>
                <div class="quote">
                    "[引言1内容。使其具有影响力或代表性。]"
                    <div class="quote-author">- @[发言人1]</div>
                </div>
                <div class="quote">
                    "[引言2内容。]"
                    <div class="quote-author">- @[发言人2]</div>
                </div>
                 <div class="quote">
                    "[引言3内容。]"
                    <div class="quote-author">- @[发言人3]</div>
                </div>
                <i class="fas fa-comment-dots card-icon"></i>
            </div>

            <div class="card links-card">
                <h2 contenteditable="false"><i class="fas fa-link"></i> 重要链接与资源</h2>
                <div class="link-item">
                    <a href="[URL链接1]" target="_blank">
                        <i class="fas fa-external-link-alt link-icon"></i>
                        <span class="link-title">[链接1标题]</span>
                    </a>
                </div>
                <div class="link-item">
                    <a href="[URL链接2]" target="_blank">
                        <i class="fas fa-external-link-alt link-icon"></i>
                        <span class="link-title">[链接2标题]</span>
                    </a>
                </div>
                <div class="link-item">
                     <i class="fas fa-file link-icon"></i>
                     <span class="link-title">[文档1标题 - 例如：共享提示词V5]</span>
                </div>
                <i class="fas fa-share-alt card-icon"></i>
            </div>

            <div class="stats-wordcloud-row">
                <div class="card stats-card">
                    <h2 contenteditable="false"><i class="fas fa-chart-line"></i> 活跃之星</h2>
                    <table class="user-stats-table">
                        <thead>
                            <tr>
                                <th class="user-name-col">用户</th>
                                <th class="message-count-col">发言数</th>
                                <th class="contribution-col">主要贡献</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-label="用户" class="user-name-col">@发言人1</td>
                                <td data-label="发言数" class="message-count-col">[数量1]+</td>
                                <td data-label="主要贡献" class="contribution-col">[用户1的主要贡献内容 - 例如：分享 PageTalk 插件和万能 Prompt 生成器]</td>
                            </tr>
                            <tr>
                                <td data-label="用户" class="user-name-col">@发言人2</td>
                                <td data-label="发言数" class="message-count-col">[数量2]+</td>
                                <td data-label="主要贡献" class="contribution-col">[用户2的主要贡献内容 - 例如：PageTalk 插件开发者，分享使用体验]</td>
                            </tr>
                            <tr>
                                <td data-label="用户" class="user-name-col">@发言人3</td>
                                <td data-label="发言数" class="message-count-col">[数量3]+</td>
                                <td data-label="主要贡献" class="contribution-col">[用户3的主要贡献内容 - 例如：参与 Agent 讨论和工具测试]</td>
                            </tr>
                        </tbody>
                    </table>
                    <i class="fas fa-user-friends card-icon"></i>
                </div>

                <div class="card wordcloud-card">
                    <h2 contenteditable="false"><i class="fas fa-cloud"></i> 词云</h2>
                    <div class="wordcloud">
                        <span class="wordcloud-item size-5">[关键词A]</span>
                        <span class="wordcloud-item size-5">[关键词B]</span>
                        <span class="wordcloud-item size-4">[关键词C]</span>
                        <span class="wordcloud-item size-4">[关键词D]</span>
                        <span class="wordcloud-item size-3">[关键词E]</span>
                        <span class="wordcloud-item size-3">[关键词F]</span>
                        <span class="wordcloud-item size-2">[关键词G]</span>
                        <span class="wordcloud-item size-2">[关键词H]</span>
                        <span class="wordcloud-item size-1">[关键词I]</span>
                    </div>
                    <i class="fas fa-tags card-icon"></i>
                </div>
            </div>

            <div class="card more-groups-intro-card">
                <h2><i class="fas fa-users-cog"></i> 更多群聊介绍</h2>
                
                <div class="group-section">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-3 flex items-center">
                        <i class="fas fa-comments fa-fw mr-3 text-indigo-500"></i> Dia浏览器使用交流
                    </h3>
                    <p class="text-gray-700 leading-relaxed text-sm">
                        专注于Dia浏览器深度使用与产品优化的专业社群。群友积极提供高质量反馈，深入探讨产品思维与技术细节，共同建设优质社群生态。
                    </p>
                </div>
    
                <div class="group-section">
                    <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                        <i class="fas fa-book-open fa-fw mr-3 text-teal-500"></i> NotebookLM使用交流
                    </h3>
                    <p class="text-gray-700 leading-relaxed text-sm">
                        一个围绕NotebookLM及相关AI工具的高质量技术互助社群。以快速响应、实用解决方案和温馨互助氛围为特色，关注AI前沿趋势与价值资源分享。
                    </p>
                </div>
    
                <div class="group-section">
                    <h3 class="text-2xl font-bold text-orange-700 mb-3 flex items-center">
                        <i class="fas fa-bolt fa-fw mr-3 text-orange-500"></i> Raycast AI 使用交流
                    </h3>
                    <p class="text-gray-700 leading-relaxed text-sm">
                        致力于探索Raycast AI前沿技术与实用技巧的交流平台。专注于分享能提升工作效率的工具、优化工作流程，并关注成本效益，实现AI赋能最大化。
                    </p>
                </div>
                <i class="fas fa-hands-helping card-icon" style="opacity: 0.07;"></i>
            </div>


            <div class="card qr-code-container-card">
                <h2><i class="fas fa-qrcode"></i> 扫码关注 / 加入我们</h2>
                <div class="qr-code-grid">
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/LdWMb8iS4oIyQixXxmMc089Pnzz/?fallback_source=1&height=1280&mount_node_token=VxYUdQXCMoZT7rxb25xciQFhn6T&mount_point=docx_image&policy=equal&width=1280" alt="向阳乔木个人微信" onerror="this.onerror=null;this.src='https://placehold.co/100x100/F5F5EE/FB651E?text=个人微信QR';">
                        <span>个人微信</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/I1w7b4cR7ot8WUxVcDac2FFInJh/?fallback_source=1&height=1280&mount_node_token=V0y8d0wYAoktYOx0eMhcYywLnOh&mount_point=docx_image&policy=equal&width=1280" alt="向阳乔木推荐看" onerror="this.onerror=null;this.src='https://placehold.co/100x100/F5F5EE/FB651E?text=公众号QR';">
                        <span>微信公众号</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/Urr2bN1yMoqmqqxuwPIcnOoFnEe/?fallback_source=1&height=1280&mount_node_token=W0IwdNMLyowx1rx7lpScsGMjnfM&mount_point=docx_image&policy=equal&width=1280" alt="向阳乔木X" onerror="this.onerror=null;this.src='https://placehold.co/100x100/F5F5EE/FB651E?text=X QR';">
                        <span>X</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/JPhybwuwNoccdTxnprwclHPxnOW/?fallback_source=1&height=1280&mount_node_token=P8FYdGaUkowBFzxUVFAcq6AanFb&mount_point=docx_image&policy=equal&width=1280" alt="AI 领导力" onerror="this.onerror=null;this.src='https://placehold.co/100x100/F5F5EE/FB651E?text=AI领导力QR';">
                        <span>AI 领导力</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/Z7UPbTbk7o6xL6xzaCOcNIY5n69/?fallback_source=1&height=1280&mount_node_token=CukPdseUDopvf8xScrVcgx1tnXO&mount_point=docx_image&policy=equal&width=1280" alt="更多群聊" onerror="this.onerror=null;this.src='https://placehold.co/100x100/F5F5EE/FB651E?text=更多群聊';">
                        <span>更多群聊</span>
                    </div>
                </div>
                 <i class="fas fa-users card-icon" style="opacity: 0.07;"></i>
            </div>

        </div> <div class="footer">
            <p>数据来源：[您的数据来源 - 例如：AI产品团聊天记录] | 生成日期：[生成日期] | 统计周期：[统计周期 - 例如：[日期]全天]</p>
            <p>[免责声明 - 例如：本报告由AI自动生成，仅供参考，不代表所有群成员观点。]</p>
        </div>
    </div> <div class="action-buttons-container">
        <button id="screenshotToClipboardBtn" class="action-button"><i class="fas fa-clipboard"></i> 拷贝截图</button>
        <button id="screenshotDownloadBtn" class="action-button"><i class="fas fa-camera"></i> 下载截图</button>
        <button id="copyHtmlBtn" class="action-button"><i class="fas fa-copy"></i> 拷贝源码</button>
        <button id="downloadHtmlBtn" class="action-button"><i class="fas fa-download"></i> 下载报告</button>
        <button id="viewHistoricalReportBtn" class="action-button"><i class="fas fa-history"></i> 查看历史日报</button>
        <button id="viewPreviousReportBtn" class="action-button"><i class="fas fa-calendar-alt"></i> 查看昨日日报</button>
    </div>
    <div id="feedback-message"></div>

    <div id="fullscreenModal" class="modal-overlay">
        <div class="modal-content card">
            <button id="fullscreenCloseBtn" class="modal-close-btn" aria-label="关闭全屏">&times;</button>
            <h2 style="padding-top: 15px;"><i class="fas fa-sitemap"></i> 核心概念关系图 (全屏)</h2>
            <div class="mindmap-controls">
                <button id="modalZoomInBtn"><i class="fas fa-search-plus"></i> 放大</button>
                <button id="modalZoomOutBtn"><i class="fas fa-search-minus"></i> 缩小</button>
                <button id="modalDownloadDiagramBtn"><i class="fas fa-download"></i> 下载 SVG</button>
            </div>
            <div class="kityminder-container" id="modalKityMinderContainer"></div>
            <div id="mermaid-modal-feedback-message"></div>
        </div>
    </div>

    <script>
    // --- KityMinder (思维导图) JavaScript 开始 ---

    // --- 全局变量 ---
    let mainKM, modalKM; // 分别存储主视图和模态框视图的KityMinder实例
    const kityminderData = { // 思维导图数据结构
        root: { // 根节点定义
            data: { text: "核心概念", expandState: "expand" }, // 根节点显示文本和默认展开状态
            children: [ // 子节点数组，添加示例数据
                { data: { text: "主要议题A", expandState: "expand" }, children: [
                    { data: { text: "议题A-1" } },
                    { data: { text: "议题A-2", expandState: "collapse" }, children: [ // 默认折叠的子节点
                        { data: { text: "A-2-详情1" } },
                        { data: { text: "A-2-详情2" } }
                    ]},
                    { data: { text: "议题A-3" } }
                ]},
                { data: { text: "主要议题B" } },
                { data: { text: "主要议题C", expandState: "expand" }, children: [
                    { data: { text: "议题C-1" } },
                    { data: { text: "议题C-2" } }
                ]}
            ]
        },
        template: 'default', // 使用KityMinder的默认模板
        theme: 'customPictureTheme', // 应用自定义主题
        version: "1.4.50" // KityMinder版本号
    };

    // --- DOM元素获取 ---
    const mainZoomInBtn = document.getElementById('zoomInBtn');
    const mainZoomOutBtn = document.getElementById('zoomOutBtn');
    const mainDownloadDiagramBtn = document.getElementById('downloadDiagramBtn');
    const mainKityMinderContainer = document.getElementById('mainKityMinderContainer');
    const mermaidMainFeedbackMessage = document.getElementById('mermaid-main-feedback-message');
    const fullscreenOpenBtn = document.getElementById('fullscreenOpenBtn');
    const fullscreenModal = document.getElementById('fullscreenModal');
    const fullscreenCloseBtn = document.getElementById('fullscreenCloseBtn');
    const modalKityMinderContainer = document.getElementById('modalKityMinderContainer');
    const modalZoomInBtn = document.getElementById('modalZoomInBtn');
    const modalZoomOutBtn = document.getElementById('modalZoomOutBtn');
    const modalDownloadDiagramBtn = document.getElementById('modalDownloadDiagramBtn');
    const mermaidModalFeedbackMessage = document.getElementById('mermaid-modal-feedback-message');

    // --- KityMinder 自定义主题定义 ---
    if (typeof kityminder !== 'undefined' && kityminder.Theme) {
        kityminder.Theme.register('customPictureTheme', {
            'root-color': 'var(--km-root-text, #333333)', 'root-background': 'var(--km-root-bg, #f0f0f0)',
            'root-stroke': 'var(--km-root-bg)', 'root-font-size': 19, 'root-font-weight': 'bold',
            'root-padding': [14, 24], 'root-margin': [10, 2], 'root-radius': 5, 'root-space': 8, 'root-stroke-width': 1,
            'main-color': 'var(--km-node-text, #ffffff)', 'main-background': 'var(--km-orange)',
            'main-stroke': 'var(--km-orange)', 'main-font-size': 19, 'main-font-weight': 'bold',
            'main-padding': [10, 20], 'main-margin': [10, 2], 'main-radius': 5, 'main-space': 4, 'main-stroke-width': 1,
            'sub-color': 'var(--km-node-text, #ffffff)', 'sub-background': 'var(--km-blue)',
            'sub-stroke': 'var(--km-blue)', 'sub-font-size': 19, 'sub-font-weight': 'bold',
            'sub-padding': [8, 16], 'sub-margin': [8, 15], 'sub-radius': 5, 'sub-space': 4, 'sub-stroke-width': 1,
            'connect-color': 'var(--km-connect-color, #777777)', 'connect-width': 1.5, 'main-connect-width': 1.5,
            'selected-connect-color': 'var(--km-orange)', 'selected-connect-width': 2.5,
            'background': "#ffffff", 'text-selection-color': 'var(--km-blue)',
            'node-padding': [6, 12], 'node-margin': [8, 15], 'node-radius': 5, 'font-size': 19, 'font-weight': 'bold',
        });
        console.log("KityMinder Debug: 自定义主题 'customPictureTheme' 已注册。");
    } else {
        console.error("KityMinder Debug: kityminder 或 kityminder.Theme 未定义。无法注册自定义主题。");
    }

    // --- KityMinder 辅助函数 ---
    function showKityMinderFeedback(element, message, type = 'info', duration = 3000) {
        if (element) {
            element.textContent = message; element.className = type; element.style.display = 'block';
            setTimeout(() => { element.textContent = ''; element.className = ''; element.style.display = 'none'; }, duration);
        }
    }

    async function downloadKityMinderAsSVG(kmInstance, baseFilename, feedbackElem) {
        if (!kmInstance || typeof kmInstance.exportData !== 'function' || !kmInstance.getRoot || !kmInstance.getRoot()) {
            showKityMinderFeedback(feedbackElem, '无法下载：思维导图实例无效或内容为空。', 'error'); return;
        }
        try {
            if (typeof kmInstance.refresh === 'function') {
                kmInstance.refresh(); await new Promise(resolve => setTimeout(resolve, 100));
            }
            const svgExportPromise = kmInstance.exportData('svg');
            if (!svgExportPromise || typeof svgExportPromise.then !== 'function') {
                showKityMinderFeedback(feedbackElem, '下载失败：导出函数行为异常。', 'error'); return;
            }
            const exportedObject = await svgExportPromise;
            let svgString = "";
            if (typeof exportedObject === 'string') { svgString = exportedObject; }
            else if (exportedObject && typeof exportedObject.data === 'string') { svgString = exportedObject.data; }
            else {
                const paper = kmInstance.getPaper && kmInstance.getPaper();
                const svgNode = paper && paper.container && paper.container.firstChild;
                if (svgNode && typeof XMLSerializer !== 'undefined') { svgString = new XMLSerializer().serializeToString(svgNode); }
            }
            if (svgString && svgString.length > 100) {
                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob); const link = document.createElement('a');
                link.href = url; link.download = `${baseFilename}.svg`; document.body.appendChild(link);
                link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                showKityMinderFeedback(feedbackElem, `${baseFilename}.svg 已下载!`, 'success');
            } else {
                showKityMinderFeedback(feedbackElem, `下载失败：生成的SVG内容为空或无效。请确保导图已正确渲染。`, 'error');
            }
        } catch (error) {
            console.error(`下载 ${baseFilename}.svg 失败:`, error);
            showKityMinderFeedback(feedbackElem, `下载 ${baseFilename}.svg 失败: ${error.message || error}`, 'error');
        }
    }

    async function initializeKityMinder(containerElement, data, feedbackElem, isModal = false) {
        console.log("正在初始化KityMinder于容器:", containerElement.id);
        containerElement.innerHTML = '';
        if (typeof kityminder === 'undefined' || typeof kityminder.Minder === 'undefined') {
            showKityMinderFeedback(feedbackElem, "KityMinder库未加载!", 'error'); return null;
        }
        try {
            const km = new kityminder.Minder({ renderTo: containerElement });
            km.importJson(data); km.enable();
            await new Promise(resolve => setTimeout(resolve, 500));
            if (km.getRoot && km.getRoot()) {
                km.getRoot().traverse(function(node) {
                    node.setData('font-weight', 'bold'); node.setData('font-size', 19); node.setData('stroke-width', 1);
                    if (node.getLevel() === 0) { node.setData('stroke', 'var(--km-root-bg)'); node.setData('padding', [14, 24]); }
                    else if (node.getLevel() === 1) { node.setData('stroke', 'var(--km-orange)'); node.setData('padding', [10, 20]); }
                    else if (node.getLevel() === 2) { node.setData('stroke', 'var(--km-blue)'); node.setData('padding', [8, 16]); }
                    else if (node.getLevel() >= 3) {
                        node.setData('background', 'var(--km-lightblue)'); node.setData('color', 'var(--km-node-text, #ffffff)');
                        node.setData('padding', [8, 16]); node.setData('stroke', 'var(--km-lightblue)');
                    }
                    node.render();
                });
                km.refresh(); await new Promise(resolve => setTimeout(resolve, 100));
                try {
                    const paper = km.getPaper(); const renderContainer = km.getRenderContainer();
                    if (!paper || !renderContainer) {
                        console.error("KityMinder paper 或 render container 不可用，无法进行自适应显示。");
                        km.execCommand('camera', km.getRoot(), 100); km.execCommand('zoom', isModal ? 85 : 75); return km;
                    }
                    const diagramBox = renderContainer.getBoundaryBox();
                    if (diagramBox && diagramBox.width > 0 && diagramBox.height > 0 && isFinite(diagramBox.x) && isFinite(diagramBox.y) && isFinite(diagramBox.width) && isFinite(diagramBox.height)) {
                        const viewPadding = 2; const containerWidth = containerElement.clientWidth; const containerHeight = containerElement.clientHeight;
                        if (containerWidth <= 0 || containerHeight <= 0) {
                            console.warn("KityMinder Debug: 容器尚无尺寸，无法进行自适应缩放。回退到默认视图。");
                            km.execCommand('camera', km.getRoot(), 100); km.execCommand('zoom', isModal ? 85 : 75); return km;
                        }
                        const usableWidth = containerWidth - 2 * viewPadding; const usableHeight = containerHeight - 2 * viewPadding;
                        const scaleX = usableWidth / diagramBox.width; const scaleY = usableHeight / diagramBox.height;
                        let targetScale = Math.min(scaleX, scaleY);
                        targetScale *= 0.995; // PADDED_ZOOM_FACTOR
                        let finalZoomPercent = Math.min(Math.max(targetScale * 100, 20), 100); // MIN_ZOOM_PERCENT, MAX_ZOOM_PERCENT
                        const diagramCenterPoint = new kity.Point(diagramBox.x + diagramBox.width / 2, diagramBox.y + diagramBox.height / 2);
                        km.execCommand('zoom', finalZoomPercent, diagramCenterPoint);
                        if (!isModal) {
                            const actualDiagramHeightAfterZoom = diagramBox.height * (finalZoomPercent / 100);
                            containerElement.style.height = Math.max(parseInt(getComputedStyle(containerElement).minHeight) || 350, actualDiagramHeightAfterZoom + 30) + 'px'; // PADDING_FOR_HEIGHT * 2
                            containerElement.style.minHeight = '0px';
                        }
                    } else {
                        console.warn("KityMinder Debug: 无效的 diagramBox 尺寸。回退到默认视图。");
                        km.execCommand('camera', km.getRoot(), 100); km.execCommand('zoom', isModal ? 80 : 70);
                    }
                } catch (e_view) {
                    console.error(`KityMinder Debug: 自适应视图调整出错 (${containerElement.id}):`, e_view);
                    km.execCommand('camera', km.getRoot(), 100); km.execCommand('zoom', isModal ? 80 : 70);
                }
                km.refresh();
            }
            console.log("KityMinder 初始化并导入数据完成:", containerElement.id); return km;
        } catch (error) {
            console.error("初始化 KityMinder 出错 (" + containerElement.id + "):", error);
            showKityMinderFeedback(feedbackElem, `初始化KityMinder失败: ${error.message}`, 'error');
            containerElement.innerHTML = `<p style="color:red; text-align:center; padding:20px;">初始化KityMinder失败: ${error.message}</p>`;
            return null;
        }
    }

    if(mainZoomInBtn) mainZoomInBtn.addEventListener('click', () => { if (mainKM) mainKM.execCommand('zoomIn'); });
    if(mainZoomOutBtn) mainZoomOutBtn.addEventListener('click', () => { if (mainKM) mainKM.execCommand('zoomOut'); });
    if(mainDownloadDiagramBtn) mainDownloadDiagramBtn.addEventListener('click', () => { downloadKityMinderAsSVG(mainKM, '核心概念关系图-主视图', mermaidMainFeedbackMessage); });

    if(fullscreenOpenBtn) fullscreenOpenBtn.addEventListener('click', () => {
        if(fullscreenModal) fullscreenModal.classList.add('active'); document.body.classList.add('modal-active');
        if(modalKityMinderContainer) modalKityMinderContainer.innerHTML = '';
        initializeKityMinder(modalKityMinderContainer, kityminderData, mermaidModalFeedbackMessage, true).then(kmInstance => modalKM = kmInstance);
    });
    if(fullscreenCloseBtn) fullscreenCloseBtn.addEventListener('click', () => {
        if(fullscreenModal) fullscreenModal.classList.remove('active'); document.body.classList.remove('modal-active');
        if(modalKityMinderContainer) modalKityMinderContainer.innerHTML = ''; modalKM = null;
    });
    if(modalZoomInBtn) modalZoomInBtn.addEventListener('click', () => { if (modalKM) modalKM.execCommand('zoomIn'); });
    if(modalZoomOutBtn) modalZoomOutBtn.addEventListener('click', () => { if (modalKM) modalKM.execCommand('zoomOut'); });
    if(modalDownloadDiagramBtn) modalDownloadDiagramBtn.addEventListener('click', () => { downloadKityMinderAsSVG(modalKM, '核心概念关系图-全屏', mermaidModalFeedbackMessage); });

    function initializeMainKityMinderDiagram() {
        console.log("DOM完全加载或函数被调用。正在初始化主KityMinder。");
        if (typeof kityminder !== 'undefined' && mainKityMinderContainer) {
            initializeKityMinder(mainKityMinderContainer, kityminderData, mermaidMainFeedbackMessage, false).then(kmInstance => mainKM = kmInstance);
        } else {
            if (mermaidMainFeedbackMessage) { showKityMinderFeedback(mermaidMainFeedbackMessage, "KityMinder库加载失败或容器未找到，无法初始化思维导图。", "error"); }
            console.error("KityMinder库或主容器不可用，无法初始化。");
        }
    }
    // --- KityMinder (思维导图) JavaScript 结束 ---

    // --- 报告页面通用 JavaScript 开始 ---
    function getCssVariable(variableName, defaultValue = null) {
        const value = getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        return value || defaultValue;
    }

    function getReportBaseName() {
        const mainTitleElement = document.querySelector('.main-card h1'); let reportTitle = "报告";
        const placeholderTitle = "[主报告标题 - 例如：AI产品团日报]";
        if (mainTitleElement && mainTitleElement.textContent) {
            const currentTitle = mainTitleElement.textContent.trim();
            if (currentTitle && currentTitle !== placeholderTitle) { reportTitle = currentTitle; }
        }
        if (reportTitle.endsWith("日报")) { reportTitle = reportTitle.substring(0, reportTitle.length - 2); }
        return reportTitle + "日报";
    }

    function getFormattedDateString() {
        const reportDateElement = document.querySelector('.main-card .date'); let dateStr = "nodate";
        const placeholderDate = "[日期 - 例如：2025年5月19日]";
        if (reportDateElement && reportDateElement.textContent) {
            const dateContent = reportDateElement.textContent.trim();
            if (dateContent && dateContent !== placeholderDate) {
                const match = dateContent.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日/);
                if (match) { dateStr = `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`; }
                else { console.warn("日期内容 '" + dateContent + "' 与 'YYYY年M月D日' 格式不匹配。文件名将使用 'nodate'。");}
            } else { console.warn("日期内容为占位符或空。文件名将使用 'nodate'。"); }
        } else { console.warn("未找到日期元素或无内容。文件名将使用 'nodate'。"); }
        return dateStr;
    }

    function sanitizeFilename(filename) { return filename.replace(/[^\w\u4e00-\u9fa5\-\.]/g, '_').replace(/_+/g, '_'); }

    const previousReportUrl = "在此处填写昨日日报的URL";
    const historicalReportUrl = "https://czkzyp3cp1.feishu.cn/base/C9gwbEvXiaQPbosqORbc9NzjnGh";

    function showReportFeedbackMessage(message, type = 'info', duration = 3000) {
        const feedbackElement = document.getElementById('feedback-message');
        if (feedbackElement) {
            feedbackElement.textContent = message; feedbackElement.className = type;
            setTimeout(() => { feedbackElement.textContent = ''; feedbackElement.className = ''; }, duration);
        }
    }

    async function captureScreenshot(elementToCapture) {
        await document.fonts.ready;
        const bodyBgColor = getCssVariable('--bg-primary', '#F5F5EE');
        const cardBgColor = getCssVariable('--bg-secondary', '#faf9f6');
        const tertiaryBgColor = getCssVariable('--bg-tertiary', '#f1f3f5');
        const highlightKeywordBgColor = getCssVariable('--highlight-keyword-bg', '#ffe8cc');
        const kityMinderContainerBgColor = '#ffffff';

        if (typeof mainKM !== 'undefined' && mainKM && typeof mainKM.refresh === 'function') {
            try { mainKM.refresh(); await new Promise(resolve => setTimeout(resolve, 150)); }
            catch (e) { console.warn("刷新KityMinder时出错:", e); }
        }

        return html2canvas(elementToCapture, {
            useCORS: true, scale: window.devicePixelRatio || 1.5, logging: false, backgroundColor: bodyBgColor,
            width: elementToCapture.scrollWidth, height: elementToCapture.scrollHeight,
            windowWidth: elementToCapture.scrollWidth, windowHeight: elementToCapture.scrollHeight,
            x: 0, y: 0, scrollX: 0, scrollY: 0,
            onclone: function(clonedDoc) {
                clonedDoc.body.style.backgroundColor = bodyBgColor;
                clonedDoc.documentElement.style.backgroundColor = bodyBgColor;
                const reportWrapper = clonedDoc.getElementById('report-content-wrapper');
                if (reportWrapper) {
                    reportWrapper.style.backgroundColor = bodyBgColor;
                    reportWrapper.style.height = elementToCapture.scrollHeight + 'px';
                    reportWrapper.style.overflow = 'visible';
                }
                clonedDoc.querySelectorAll('.card').forEach(card => { card.style.backgroundColor = cardBgColor; card.style.overflow = 'visible'; });
                const mindmapCardContainer = clonedDoc.querySelector('.mindmap-card-container.card');
                if (mindmapCardContainer) { mindmapCardContainer.style.backgroundColor = cardBgColor; }
                clonedDoc.querySelectorAll('.kityminder-container').forEach(kmContainer => {
                    kmContainer.style.backgroundColor = kityMinderContainerBgColor; kmContainer.style.overflow = 'visible';
                    const svgElements = kmContainer.querySelectorAll('svg');
                    svgElements.forEach(svg => {
                        svg.style.overflow = 'visible !important';
                        const originalKmContainer = document.getElementById(kmContainer.id);
                        if (originalKmContainer) {
                            const originalSvg = originalKmContainer.querySelector('svg');
                            if (originalSvg) {
                                svg.setAttribute('width', originalSvg.getAttribute('width'));
                                svg.setAttribute('height', originalSvg.getAttribute('height'));
                                svg.setAttribute('viewBox', originalSvg.getAttribute('viewBox'));
                            }
                        }
                    });
                });
                clonedDoc.querySelectorAll('.link-item, .qr-code-item, .meta-info span, .keyword').forEach(el => { el.style.backgroundColor = tertiaryBgColor; });
                clonedDoc.querySelectorAll('.highlight-keyword').forEach(el => {
                    el.style.display = 'inline'; el.style.padding = '1px 2px'; el.style.lineHeight = '1.2';
                    el.style.boxDecorationBreak = 'clone'; el.style.webkitBoxDecorationBreak = 'clone';
                    el.style.backgroundColor = highlightKeywordBgColor;
                });
                const allElements = clonedDoc.getElementsByTagName("*");
                for (let i = 0; i < allElements.length; i++) {
                    allElements[i].style.transition = 'none !important'; allElements[i].style.animation = 'none !important';
                }
            }
        });
    }

    const screenshotToClipboardBtn = document.getElementById('screenshotToClipboardBtn');
    if(screenshotToClipboardBtn) screenshotToClipboardBtn.addEventListener('click', async function() {
        const reportContent = document.getElementById('report-content-wrapper');
        if (!reportContent) { showReportFeedbackMessage('截图错误: 未找到报告内容。', 'error'); return; }
        const actionButtons = document.querySelector('.action-buttons-container');
        const feedbackMsgElement = document.getElementById('feedback-message');
        const originalButtonText = this.innerHTML; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...'; this.disabled = true;
        if(actionButtons) actionButtons.style.visibility = 'hidden'; if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'hidden';
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            const canvas = await captureScreenshot(reportContent);
            canvas.toBlob(async function(blob) {
                if (blob) {
                    try {
                        if (navigator.clipboard && navigator.clipboard.write) {
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            showReportFeedbackMessage('截图已拷贝到剪贴板!', 'success');
                        } else {
                            const dataUrl = canvas.toDataURL('image/png'); const img = document.createElement('img');
                            img.src = dataUrl; img.style.maxWidth = '100%'; img.style.border = '1px solid #ccc';
                            const tempContainer = document.createElement('div');
                            tempContainer.style.cssText = 'position:fixed;top:10px;left:10px;z-index:9999;background-color:white;padding:10px;border:1px solid black;';
                            tempContainer.innerHTML = '<strong>请手动右键复制图片:</strong><br>'; tempContainer.appendChild(img);
                            document.body.appendChild(tempContainer);
                            showReportFeedbackMessage('截图已生成。请手动右键复制图片。此提示将在10秒后消失。', 'info', 10000);
                            setTimeout(() => { if(document.body.contains(tempContainer)) document.body.removeChild(tempContainer); }, 10000);
                        }
                    } catch (copyError) {
                        console.error('拷贝到剪贴板失败:', copyError);
                        showReportFeedbackMessage('拷贝截图到剪贴板失败: ' + copyError.message, 'error', 5000);
                    }
                } else { throw new Error('无法将Canvas转换为Blob。'); }
            }, 'image/png');
        } catch (error) {
            console.error('截图捕获失败:', error); showReportFeedbackMessage('截图捕获失败: ' + error.message, 'error');
        } finally {
            if(actionButtons) actionButtons.style.visibility = 'visible'; if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'visible';
            this.innerHTML = originalButtonText; this.disabled = false;
        }
    });

    const screenshotDownloadBtn = document.getElementById('screenshotDownloadBtn');
    if(screenshotDownloadBtn) screenshotDownloadBtn.addEventListener('click', async function() {
        const reportContent = document.getElementById('report-content-wrapper');
        if (!reportContent) { showReportFeedbackMessage('截图错误: 未找到报告内容。', 'error'); return; }
        const actionButtons = document.querySelector('.action-buttons-container');
        const feedbackMsgElement = document.getElementById('feedback-message');
        const originalButtonText = this.innerHTML; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...'; this.disabled = true;
        if(actionButtons) actionButtons.style.visibility = 'hidden'; if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'hidden';
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            const canvas = await captureScreenshot(reportContent);
            const image = canvas.toDataURL('image/png'); const link = document.createElement('a');
            const reportBaseName = getReportBaseName(); const dateSuffix = getFormattedDateString();
            let filename = sanitizeFilename(reportBaseName + '-' + dateSuffix) + '.png';
            link.href = image; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showReportFeedbackMessage('截图已下载为 ' + filename + '!', 'success');
        } catch (error) {
            console.error('下载截图失败:', error); showReportFeedbackMessage('下载截图失败: ' + error.message, 'error');
        } finally {
            if(actionButtons) actionButtons.style.visibility = 'visible'; if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'visible';
            this.innerHTML = originalButtonText; this.disabled = false;
        }
    });

    const downloadHtmlBtn = document.getElementById('downloadHtmlBtn');
    if(downloadHtmlBtn) downloadHtmlBtn.addEventListener('click', function() {
        try {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            const reportBaseName = getReportBaseName(); const dateSuffix = getFormattedDateString();
            let filename = sanitizeFilename(reportBaseName + '-' + dateSuffix) + '.html';
            link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link);
            link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            showReportFeedbackMessage('HTML报告已下载为 ' + filename + '!', 'success');
        } catch (error) {
            console.error('下载HTML失败:', error); showReportFeedbackMessage('下载HTML失败: ' + error.message, 'error');
        }
    });

    const copyHtmlBtn = document.getElementById('copyHtmlBtn');
    if(copyHtmlBtn) copyHtmlBtn.addEventListener('click', function() {
        const htmlContent = document.documentElement.outerHTML; const Gthis = this;
        const originalButtonHTML = Gthis.innerHTML; const textarea = document.createElement('textarea');
        textarea.value = htmlContent; textarea.style.position = 'fixed'; textarea.style.top = '-9999px'; textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        try {
            textarea.select(); textarea.setSelectionRange(0, textarea.value.length);
            if (document.execCommand('copy')) {
                Gthis.innerHTML = '<i class="fas fa-check"></i> 已拷贝!';
                showReportFeedbackMessage('HTML已拷贝到剪贴板!', 'success', 2000);
            } else {
                Gthis.innerHTML = '<i class="fas fa-times"></i> 拷贝失败';
                showReportFeedbackMessage('拷贝失败。您的浏览器可能不支持此操作。', 'error', 2000);
            }
        } catch (err) {
            Gthis.innerHTML = '<i class="fas fa-times"></i> 拷贝出错';
            showReportFeedbackMessage('拷贝出错: ' + err.message, 'error', 2000); console.error('拷贝HTML源码出错:', err);
        } finally {
            setTimeout(function() { Gthis.innerHTML = originalButtonHTML; }, 2000);
            document.body.removeChild(textarea);
        }
    });

    const viewHistoricalReportBtn = document.getElementById('viewHistoricalReportBtn');
    if(viewHistoricalReportBtn) viewHistoricalReportBtn.addEventListener('click', function() {
        const urlToOpen = historicalReportUrl.trim();
        if (urlToOpen && (urlToOpen.startsWith('http://') || urlToOpen.startsWith('https://'))) {
            const newWindow = window.open(urlToOpen, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                showReportFeedbackMessage('无法打开新窗口。请检查您的弹出窗口拦截设置。', 'error', 5000);
            }
        } else { showReportFeedbackMessage('历史日报的URL无效。', 'error', 5000); }
    });

    const viewPreviousReportBtn = document.getElementById('viewPreviousReportBtn');
    if(viewPreviousReportBtn) viewPreviousReportBtn.addEventListener('click', function() {
        const urlToOpen = previousReportUrl.trim();
        const placeholderUrlText = "在此处填写昨日日报的URL";
        if (urlToOpen && urlToOpen !== placeholderUrlText && (urlToOpen.startsWith('http://') || urlToOpen.startsWith('https://') || !urlToOpen.includes('://'))) {
            const newWindow = window.open(urlToOpen, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                showReportFeedbackMessage('无法打开新窗口。请检查您的弹出窗口拦截设置。', 'error', 5000);
            }
        } else { showReportFeedbackMessage('昨日日报的URL未配置或无效。请检查脚本中的 previousReportUrl 变量。', 'error', 5000); }
    });

    // Removed adjustActionButtonsLayout function and its calls from load/resize listeners
    // CSS will now solely handle the action button layout.

    // --- 页面加载和窗口大小改变时的事件监听 ---
    window.addEventListener('load', () => {
        initializeMainKityMinderDiagram();
        // adjustActionButtonsLayout(); // Removed call
    });
    // window.addEventListener('resize', adjustActionButtonsLayout); // Removed call

    // --- 报告页面通用 JavaScript 结束 ---
    </script>
</body>
</html>
