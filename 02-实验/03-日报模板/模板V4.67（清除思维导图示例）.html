<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[在此处填写报告标题] - [日期]</title>
    <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5rLesXWW/sGuLhYFChxgYnz2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script>

    <style>
        :root {
            /* 极简主义风格配色 */
            --bg-primary: #F5F5EE; /* 调整为与模板一致的米白色 */
            --bg-secondary: #faf9f6;
            --bg-tertiary: #f1f3f5;
            --text-primary: #212529;
            --text-secondary: #495057;
            --accent-primary: #FB651E; /* 调整为与模板一致的橙色 */
            --accent-secondary: #ff8906;
            --accent-tertiary: #e8590c;
            --accent-blue: #007EFF;    /* 特定元素的蓝色强调 (from mindmap template) */
            --accent-purple: #7048e8;
            --accent-cyan: #10B981;    /* 词云的青色强调 (from mindmap template's 3rd level node) */
            --highlight-keyword-bg: #ffe8cc;
            --highlight-name-color: #7048e8;
            --card-padding: 24px;
            --grid-gap: 16px;
            --card-radius: 12px;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --font-family: 'Inter', 'SF Pro Display', 'Segoe UI', sans-serif;

            /* KityMinder Custom Theme Colors */
            --km-orange: #FB651E;
            --km-blue: #007EFF;
            --km-lightblue: #10B981;
            --km-root-bg: #f0f0f0;
            --km-root-stroke: var(--km-root-bg);
            --km-root-text: #333333;
            --km-node-text: #ffffff;
            --km-connect-color: #777777;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        body.modal-active {
            overflow: hidden;
        }

        h1, h2, h3, h4 {
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
        }

        h2 {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--accent-blue); /* Using accent-blue for H3 as in mindmap template */
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: var(--grid-gap);
            margin-top: 20px;
            grid-template-areas: /* Updated grid areas */
                "main        main        main        main        main        main        main        main        main        main        main        main"
                "topics      topics      topics      topics      topics      topics      topics      topics      topics      topics      topics      topics"
                "mindmap     mindmap     mindmap     mindmap     mindmap     mindmap     mindmap     mindmap     mindmap     mindmap     mindmap     mindmap"
                "quote       quote       quote       quote       quote       quote       links       links       links       links       links       links"
                "bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row  bottom_row"
                "qrcode      qrcode      qrcode      qrcode      qrcode      qrcode      qrcode      qrcode      qrcode      qrcode      qrcode      qrcode"; /* New QR Code area */
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--card-radius);
            padding: var(--card-padding);
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-primary);
        }

        .card-icon {
            position: absolute;
            bottom: var(--card-padding);
            right: var(--card-padding);
            font-size: 4rem;
            opacity: 0.07;
            color: var(--accent-primary);
            z-index: 0;
        }

        /* Grid Area Assignments */
        .main-card { grid-area: main; }
        .topic-cards-wrapper {
            grid-area: topics;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--grid-gap);
        }
        .mindmap-card-container { grid-area: mindmap; }
        .quote-card { grid-area: quote; }
        .links-card { grid-area: links; }
        .stats-wordcloud-row {
            grid-area: bottom_row;
            display: flex;
            gap: var(--grid-gap);
            align-items: stretch;
        }
        .qr-code-container-card { grid-area: qrcode; } /* Assign QR code to its area */


        .stats-card {
            flex-grow: 7;
            flex-shrink: 1;
            flex-basis: 0;
            min-width: 0;
        }
        .wordcloud-card {
            flex-grow: 5;
            flex-shrink: 1;
            flex-basis: 0;
            min-width: 0;
            max-width: 50%;
        }

        .topic-card {
            grid-column: span 6;
            min-height: 250px;
        }
        .topic-card > .topic-card-content-wrapper {
            flex-grow: 1;
            padding-bottom: 1rem;
        }
        .topic-cards-wrapper > .topic-card:nth-last-child(1):nth-child(odd) {
            grid-column: span 12;
        }

        .main-card h1 { text-align: center; }
        .main-card .date { text-align: center; }
        .date { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .meta-info { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 1rem; justify-content: center; }
        .meta-info span { background-color: var(--bg-tertiary); padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; color: var(--accent-blue); }
        .summary { margin-top: 1rem; line-height: 1.7; text-align: left; }
        .topic-category { display: inline-block; background-color: var(--accent-tertiary); color: var(--bg-primary); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 0.5rem; }
        .topic-keywords { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 0.75rem; margin-bottom: 0.75rem; }
        .keyword { background-color: var(--bg-tertiary); color: var(--accent-primary); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .highlight-keyword { background-color: var(--highlight-keyword-bg); padding: 1px 2px; border-radius: 2px; font-weight: 500; display: inline; line-height: 1.2; box-decoration-break: clone; -webkit-box-decoration-break: clone; }
        .highlight-name { color: var(--highlight-name-color); font-weight: 500; }
        .topic-mentions { font-size: 0.9rem; color: var(--text-secondary); }
        .quote { position: relative; padding-left: 20px; margin: 10px 0; font-style: italic; color: var(--text-secondary); }
        .quote::before { content: '"'; position: absolute; left: 0; top: 0; font-size: 1.5rem; color: var(--accent-tertiary); }
        .quote-author { text-align: right; font-size: 0.9rem; color: var(--accent-tertiary); margin-top: 5px; }
        .link-item { display: flex; align-items: center; margin-bottom: 10px; padding: 8px; border-radius: 6px; background-color: var(--bg-tertiary); transition: background-color 0.2s ease; text-decoration: none; }
        .link-item:hover { background-color: rgba(0, 123, 255, 0.1); } /* Updated hover color to match accent-blue */
        .link-item a { text-decoration: none; color: inherit; display: flex; align-items: center; width: 100%; }
        .link-item a:hover .link-title { text-decoration: underline; color: var(--accent-blue); }
        .link-icon { margin-right: 10px; color: var(--accent-blue); }
        .link-title { flex-grow: 1; color: var(--text-primary); }
        .link-title.is-link { color: var(--accent-blue); }
        .link-title.is-link:hover { text-decoration: underline; }
        .user-stats-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        .user-stats-table th { text-align: center; padding: 0.75rem 0.5rem; border-bottom: 2px solid var(--accent-primary); color: var(--text-primary); font-weight: 600; font-size: 0.9rem; }
        .user-stats-table td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--bg-tertiary); color: var(--text-secondary); font-size: 0.85rem; vertical-align: top; text-align: left; }
        .user-stats-table .user-name-col { width: 25%; font-weight: 500; word-break: break-all; }
        .user-stats-table .message-count-col { text-align: center; width: 15%; white-space: nowrap; }
        .user-stats-table .contribution-col { width: 60%; word-break: break-all; }
        .user-stats-table tr:last-child td { border-bottom: none; }
        .wordcloud { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 20px 0; }
        .wordcloud-item { padding: 5px 10px; border-radius: 4px; font-weight: 500; transition: transform 0.2s ease; }
        .wordcloud-item:hover { transform: scale(1.1); }
        .size-1 { font-size: 0.9rem; color: var(--text-secondary); }
        .size-2 { font-size: 1.1rem; color: var(--accent-cyan); } /* Using accent-cyan for consistency */
        .size-3 { font-size: 1.3rem; color: var(--accent-blue); }
        .size-4 { font-size: 1.5rem; color: var(--accent-purple); }
        .size-5 { font-size: 1.8rem; color: var(--accent-tertiary); }

        /* 二维码区域样式 (Copied from 在线二维码.html and adapted) */
        .qr-code-container-card {
            /* margin-top: 20px; /* Removed, as it's now part of the grid */
            /* margin-bottom: 20px; /* Removed */
            /* animation-delay: 1.0s; /* Will be handled by grid area animation if needed */
        }

        .qr-code-container-card h2 { /* Title for QR section */
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: var(--accent-primary);
            text-align: center;
            font-weight: 600;
        }
        .qr-code-container-card h2 i {
            margin-right: 0.5rem;
        }

        .qr-code-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Or center, space-between */
            gap: var(--grid-gap, 16px);
            padding: 10px 0; /* Added some padding for better spacing */
        }

        .qr-code-item {
            background-color: var(--bg-tertiary);
            border-radius: 8px; /* Slightly smaller radius for a tighter look */
            padding: 1rem;
            flex: 0 0 130px; /* Fixed base size, adjust as needed */
            height: 130px; /* Fixed height for square items */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically */
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .qr-code-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .qr-code-item img {
            width: 100px; /* QR image width */
            height: 100px; /* QR image height */
            object-fit: contain;
            margin-bottom: 0.5rem; /* Space between image and text */
        }
        .qr-code-item span {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: auto; /* Pushes text to bottom if image is small */
        }


        .action-buttons-container { text-align: center; margin: 20px 0; padding-bottom: 20px; }
        .action-button { background-color: var(--accent-primary); color: white; border: none; padding: 10px 20px; border-radius: var(--card-radius); font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; margin: 5px 10px; box-shadow: var(--card-shadow); display: inline-flex; align-items: center; justify-content: center; }
        .action-button:hover { background-color: var(--accent-secondary); transform: translateY(-2px); }
        .action-button i, .action-button .fas { margin-right: 8px; }
        .footer { margin-top: 30px; text-align: center; color: var(--text-secondary); font-size: 0.9rem; }
        #report-content-wrapper .footer { margin-top: 30px; padding-bottom: 20px; }

        /* KityMinder Specific Styles */
        .mindmap-card {}
        .mindmap-card h2 i { margin-right: 8px; }
        .mindmap-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .mindmap-controls button { background-color: var(--km-blue); color: white; border: none; padding: 8px 12px; border-radius: var(--card-radius); font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; }
        .mindmap-controls button:hover { background-color: #005bb5; }
        .mindmap-controls button i { margin-right: 5px; }
        .mindmap-controls .fullscreen-toggle-btn { margin-left: auto; }

        .kityminder-container {
            flex-grow: 1;
            overflow: hidden;
            background-color: #fff;
            border-radius: 8px;
            padding: 0;
            border: 1px solid var(--bg-tertiary);
            min-height: 400px;
            position: relative;
            transition: height 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kityminder-container:empty::before {
            content: "思维导图加载中或内容为空...";
            color: var(--text-secondary); font-style: italic; text-align: center;
            padding: 20px; display: flex; justify-content: center; align-items: center;
            height: 100%; min-height: 150px;
        }

        #mermaid-main-feedback-message, #mermaid-modal-feedback-message {
            text-align: center; margin-top: 15px; padding: 8px; border-radius: 4px;
            font-weight: 500; font-size: 0.9rem; display: none;
        }
        #mermaid-main-feedback-message.success, #mermaid-modal-feedback-message.success {
            color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; display: block;
        }
        #mermaid-main-feedback-message.error, #mermaid-modal-feedback-message.error {
            color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; display: block;
        }
        #mermaid-main-feedback-message.info, #mermaid-modal-feedback-message.info {
            color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; display: block;
        }

        #feedback-message { text-align: center; margin-top: 10px; font-weight: 500; }
        #feedback-message.success { color: green; }
        #feedback-message.error { color: red; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); display: none;
            justify-content: center; align-items: center; z-index: 1000; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            width: 95%; height: 90%; max-width: 1200px;
        }
        .modal-close-btn {
            position: absolute; top: 15px; right: 20px; background: none; border: none;
            font-size: 2.2rem; color: var(--text-secondary); cursor: pointer;
            line-height: 1; padding: 5px; z-index: 1010;
        }
        .modal-close-btn:hover { color: var(--text-primary); }
        #modalKityMinderContainer {
            flex-grow: 1; min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card { animation: fadeIn 0.5s ease forwards; }
        .main-card { animation-delay: 0.1s; }
        .topic-cards-wrapper .topic-card:nth-child(1) { animation-delay: 0.2s; }
        .topic-cards-wrapper .topic-card:nth-child(2) { animation-delay: 0.3s; }
        .topic-cards-wrapper .topic-card:nth-child(3) { animation-delay: 0.4s; }
        .topic-cards-wrapper .topic-card:nth-child(4) { animation-delay: 0.5s; }
        .mindmap-card-container .card { animation-delay: 0.6s; }
        .quote-card { animation-delay: 0.7s; }
        .links-card { animation-delay: 0.8s; }
        .stats-wordcloud-row { animation: fadeIn 0.5s ease forwards; animation-delay: 0.9s; }
        .qr-code-container-card { animation: fadeIn 0.5s ease forwards; animation-delay: 1.0s; } /* Animation for QR card */


        #report-content-wrapper .footer { animation: fadeIn 0.5s ease forwards; animation-delay: 1.1s; }
        .action-buttons-container { animation: fadeIn 0.5s ease forwards; animation-delay: 1.2s; }


        @media (max-width: 768px) {
            body { padding: 10px; font-size: 14px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.1rem; }
            .grid-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "main"
                    "topics"
                    "mindmap"
                    "quote"
                    "links"
                    "bottom_row"
                    "qrcode"; /* QR code in its own row on mobile */
            }
            .stats-wordcloud-row {
                flex-direction: column;
            }
            .stats-wordcloud-row > .card {
                width: 100%;
                flex-basis: auto !important;
                max-width: none;
            }

            .topic-cards-wrapper { grid-template-columns: 1fr; }
            .topic-card { grid-column: 1 / -1; min-height: auto; }
            .topic-card > .topic-card-content-wrapper { padding-bottom: 1rem; }
            .topic-mentions { position: static; margin-top: 10px; margin-bottom: 10px; text-align: left; }
            .card-icon { font-size: 2.5rem; opacity:0.05; }
            .mindmap-card .card-icon { bottom: 15px; right: 15px; }

            .user-stats-table th, .user-stats-table td { padding: 0.5rem 0.25rem; font-size: 0.8rem; }
            .user-stats-table td { text-align: left; }
            .user-stats-table .message-count-col { text-align: center; }
            .action-button { padding: 8px 15px; font-size: 0.9rem; }
            .action-buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
            .action-buttons-container .action-button { width: calc(50% - 10px); min-width: 180px; margin: 5px 0; }

            .mindmap-card-container .card { padding: 15px; }
            .mindmap-controls button { font-size: 0.8rem; padding: 6px 10px; }
            .modal-content { width: 100%; height: 95%; padding:15px; }
            .modal-close-btn { font-size: 1.8rem; top:10px; right:10px;}

            /* 二维码区域响应式 (Copied and adapted) */
            .qr-code-container-card h2 {
                font-size: 1.4rem;
                margin-bottom: 1rem;
            }
            .qr-code-grid {
                gap: 12px;
            }
            .qr-code-item {
                flex-basis: calc(50% - 6px); /* Two items per row on smaller tablets */
                height: auto; /* Auto height based on content */
                aspect-ratio: 1/1; /* Maintain square shape */
                padding: 0.75rem;
            }
            .qr-code-item img {
                width: 70%; /* Relative width */
                height: 70%; /* Relative height */
                max-width: 80px; /* Max physical size */
                max-height: 80px; /* Max physical size */
                object-fit: contain;
                margin-bottom: 0.3rem;
            }
            .qr-code-item span {
                font-size: 0.7rem;
            }
        }
        @media (max-width: 480px) {
            .action-buttons-container .action-button { width: 80%; }
            .user-stats-table { display: block; overflow-x: auto; }
            .user-stats-table th, .user-stats-table td { white-space: normal; }
            .user-stats-table thead, .user-stats-table tbody, .user-stats-table tr { display: block; }
            .user-stats-table tr { border-bottom: 1px solid var(--bg-tertiary); }
            .user-stats-table th { display: none; }
            .user-stats-table td { display: block; text-align: left; border-bottom: none; padding-left: 0.5rem; }
            .user-stats-table td.message-count-col { text-align: left; }
            .user-stats-table td::before { content: attr(data-label); font-weight: bold; display: inline-block; width: 100px; margin-right: 10px; color: var(--text-primary); text-align: left; }
            .user-stats-table tr:last-child { border-bottom: none; }

            /* Smaller screen QR code adjustments */
            .qr-code-item {
                 flex-basis: calc(50% - 6px); /* Still two items per row, but might get tight */
            }
            .qr-code-item img {
                width: 60%;
                height: 60%;
                max-width: 70px;
                max-height: 70px;
            }
            .qr-code-item span {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <div id="report-content-wrapper">
        <div class="grid-container">
            <div class="card main-card">
                <h1 contenteditable="false">[主报告标题 - 例如：AI产品团日报]</h1> <div class="date">[日期 - 例如：2025年5月19日]</div>
                <div class="meta-info">
                    <span><i class="fas fa-comment"></i> 消息数: [数字]+</span>
                    <span><i class="fas fa-users"></i> 活跃用户: [数字]+</span>
                    <span><i class="fas fa-fire"></i> 热点话题: [数字]</span>
                </div>
                <p class="summary">[在此处填写当日讨论的总体摘要。保持简洁明了，突出群组的主要主题和氛围。]</p>
                <i class="fas fa-microchip card-icon"></i>
            </div>

            <div class="topic-cards-wrapper">
                <div class="card topic-card">
                    <div class="topic-card-content-wrapper">
                        <h2 contenteditable="false"><i class="fas fa-lightbulb"></i> [主题1标题]</h2> <div class="topic-category">[分类1 - 例如：工具技巧]</div>
                        <p>关于<span class="highlight-keyword">插件功能</span>的讨论，特别是<span class="highlight-name">@用户A</span>提到的<span class="highlight-keyword">上下文处理</span>能力。</p>
                        <div class="topic-keywords">
                            <span class="keyword">[关键词1A]</span>
                            <span class="keyword">[关键词1B]</span>
                            <span class="keyword">[关键词1C]</span>
                        </div>
                        <div class="topic-mentions"><i class="fas fa-bullhorn"></i> 提及次数: [数量1]</div>
                    </div>
                    <i class="fas fa-tools card-icon"></i>
                </div>
                <div class="card topic-card">
                    <div class="topic-card-content-wrapper">
                        <h2 contenteditable="false"><i class="fas fa-rocket"></i> [主题2标题]</h2> <div class="topic-category">[分类2 - 例如：新功能]</div>
                        <p><span class="highlight-name">@用户B</span>分享了<span class="highlight-keyword">AI搜索</span>的最新进展和<span class="highlight-keyword">地区限制</span>问题。</p>
                        <div class="topic-keywords">
                            <span class="keyword">[关键词2A]</span>
                            <span class="keyword">[关键词2B]</span>
                        </div>
                        <div class="topic-mentions"><i class="fas fa-bullhorn"></i> 提及次数: [数量2]</div>
                    </div>
                    <i class="fas fa-star card-icon"></i>
                </div>
                <div class="card topic-card">
                    <div class="topic-card-content-wrapper">
                        <h2 contenteditable="false"><i class="fas fa-comments-dollar"></i> [主题3标题]</h2> <div class="topic-category">[分类3 - 例如：工具体验]</div>
                        <p>大家对<span class="highlight-keyword">Agent技术</span>的<span class="highlight-keyword">商业化前景</span>进行了探讨，<span class="highlight-name">@用户C</span>提出了独到见解。</p>
                        <div class="topic-keywords">
                            <span class="keyword">[关键词3A]</span>
                            <span class="keyword">[关键词3B]</span>
                            <span class="keyword">[关键词3C]</span>
                        </div>
                        <div class="topic-mentions"><i class="fas fa-bullhorn"></i> 提及次数: [数量3]</div>
                    </div>
                    <i class="fas fa-comments card-icon"></i>
                </div>
            </div>

            <div class="mindmap-card-container card">
                <div class="mindmap-card">
                    <h2><i class="fas fa-sitemap"></i> 核心概念关系图</h2>
                    <div class="mindmap-controls">
                        <button id="zoomInBtn"><i class="fas fa-search-plus"></i> 放大</button>
                        <button id="zoomOutBtn"><i class="fas fa-search-minus"></i> 缩小</button>
                        <button id="downloadDiagramBtn"><i class="fas fa-download"></i> 下载 SVG</button>
                        <button id="fullscreenOpenBtn" class="fullscreen-toggle-btn"><i class="fas fa-expand"></i> 全屏</button>
                    </div>
                    <div class="kityminder-container" id="mainKityMinderContainer"></div>
                    <div id="mermaid-main-feedback-message"></div>
                    <i class="fas fa-project-diagram card-icon"></i>
                </div>
            </div>

            <div class="card quote-card">
                <h2 contenteditable="false"><i class="fas fa-quote-left"></i> 精彩引用</h2>
                <div class="quote">
                    "[引言1内容。使其具有影响力或代表性。]"
                    <div class="quote-author">- @[发言人1]</div>
                </div>
                <div class="quote">
                    "[引言2内容。]"
                    <div class="quote-author">- @[发言人2]</div>
                </div>
                <div class="quote">
                    "[引言3内容。]"
                    <div class="quote-author">- @[发言人3]</div>
                </div>
                <i class="fas fa-comment-dots card-icon"></i>
            </div>

            <div class="card links-card">
                <h2 contenteditable="false"><i class="fas fa-link"></i> 重要链接与资源</h2>
                <div class="link-item">
                    <a href="[URL链接1]" target="_blank">
                        <i class="fas fa-external-link-alt link-icon"></i>
                        <span class="link-title">[链接1标题]</span>
                    </a>
                </div>
                <div class="link-item">
                    <a href="[URL链接2]" target="_blank">
                        <i class="fas fa-external-link-alt link-icon"></i>
                        <span class="link-title">[链接2标题]</span>
                    </a>
                </div>
                <div class="link-item"> <i class="fas fa-file link-icon"></i>
                    <span class="link-title">[文档1标题 - 例如：共享提示词V5]</span>
                </div>
                <i class="fas fa-share-alt card-icon"></i>
            </div>

            <div class="stats-wordcloud-row">
                <div class="card stats-card">
                    <h2 contenteditable="false"><i class="fas fa-chart-line"></i> 活跃之星</h2>
                    <table class="user-stats-table">
                        <thead>
                            <tr>
                                <th class="user-name-col">用户</th>
                                <th class="message-count-col">发言数</th>
                                <th class="contribution-col">主要贡献</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-label="用户" class="user-name-col">@发言人1</td>
                                <td data-label="发言数" class="message-count-col">[数量1]+</td>
                                <td data-label="主要贡献" class="contribution-col">[用户1的主要贡献内容 - 例如：分享 PageTalk 插件和万能 Prompt 生成器]</td>
                            </tr>
                            <tr>
                                <td data-label="用户" class="user-name-col">@发言人2</td>
                                <td data-label="发言数" class="message-count-col">[数量2]+</td>
                                <td data-label="主要贡献" class="contribution-col">[用户2的主要贡献内容 - 例如：PageTalk 插件开发者，分享使用体验]</td>
                            </tr>
                            <tr>
                                <td data-label="用户" class="user-name-col">@发言人3</td>
                                <td data-label="发言数" class="message-count-col">[数量3]+</td>
                                <td data-label="主要贡献" class="contribution-col">[用户3的主要贡献内容 - 例如：参与 Agent 讨论和工具测试]</td>
                            </tr>
                        </tbody>
                    </table>
                    <i class="fas fa-user-friends card-icon"></i>
                </div>

                <div class="card wordcloud-card">
                    <h2 contenteditable="false"><i class="fas fa-cloud"></i> 词云</h2>
                    <div class="wordcloud">
                        <span class="wordcloud-item size-5">[关键词A]</span>
                        <span class="wordcloud-item size-5">[关键词B]</span>
                        <span class="wordcloud-item size-4">[关键词C]</span>
                        <span class="wordcloud-item size-4">[关键词D]</span>
                        <span class="wordcloud-item size-3">[关键词E]</span>
                        <span class="wordcloud-item size-3">[关键词F]</span>
                        <span class="wordcloud-item size-2">[关键词G]</span>
                        <span class="wordcloud-item size-2">[关键词H]</span>
                        <span class="wordcloud-item size-1">[关键词I]</span>
                    </div>
                    <i class="fas fa-tags card-icon"></i>
                </div>
            </div>

            <div class="card qr-code-container-card">
                <h2><i class="fas fa-qrcode"></i> 扫码关注 / 加入我们</h2>
                <div class="qr-code-grid">
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/LdWMb8iS4oIyQixXxmMc089Pnzz/?fallback_source=1&height=1280&mount_node_token=VxYUdQXCMoZT7rxb25xciQFhn6T&mount_point=docx_image&policy=equal&width=1280" alt="向阳乔木个人微信">
                        <span>个人微信</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/I1w7b4cR7ot8WUxVcDac2FFInJh/?fallback_source=1&height=1280&mount_node_token=V0y8d0wYAoktYOx0eMhcYywLnOh&mount_point=docx_image&policy=equal&width=1280" alt="向阳乔木推荐看">
                        <span>微信公众号</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/Urr2bN1yMoqmqqxuwPIcnOoFnEe/?fallback_source=1&height=1280&mount_node_token=W0IwdNMLyowx1rx7lpScsGMjnfM&mount_point=docx_image&policy=equal&width=1280" alt="向阳乔木X">
                        <span>X</span>
                    </div>
                    <div class="qr-code-item">
                        <img src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/JPhybwuwNoccdTxnprwclHPxnOW/?fallback_source=1&height=1280&mount_node_token=P8FYdGaUkowBFzxUVFAcq6AanFb&mount_point=docx_image&policy=equal&width=1280" alt="AI 领导力">
                        <span>AI 领导力</span>
                    </div>
                </div>
                 <i class="fas fa-users card-icon" style="opacity: 0.07;"></i> </div>

        </div> <div class="footer">
            <p>数据来源：[您的数据来源 - 例如：AI产品团聊天记录] | 生成日期：[生成日期] | 统计周期：[统计周期 - 例如：[日期]全天]</p>
            <p>[免责声明 - 例如：本报告由AI自动生成，仅供参考，不代表所有群成员观点。]</p>
        </div>
    </div> <div class="action-buttons-container">
        <button id="screenshotToClipboardBtn" class="action-button"><i class="fas fa-clipboard"></i> 拷贝截图</button>
        <button id="screenshotDownloadBtn" class="action-button"><i class="fas fa-camera"></i> 下载截图</button>
        <button id="copyHtmlBtn" class="action-button"><i class="fas fa-copy"></i> 拷贝源码</button>
        <button id="downloadHtmlBtn" class="action-button"><i class="fas fa-download"></i> 下载报告</button>
        <button id="viewPreviousReportBtn" class="action-button"><i class="fas fa-calendar-alt"></i> 查看昨日日报</button>
    </div>
    <div id="feedback-message"></div>

    <div id="fullscreenModal" class="modal-overlay">
        <div class="modal-content card">
            <button id="fullscreenCloseBtn" class="modal-close-btn" aria-label="关闭全屏">&times;</button>
            <h2 style="padding-top: 15px;"><i class="fas fa-sitemap"></i> 核心概念关系图 (全屏)</h2>
            <div class="mindmap-controls">
                <button id="modalZoomInBtn"><i class="fas fa-search-plus"></i> 放大</button>
                <button id="modalZoomOutBtn"><i class="fas fa-search-minus"></i> 缩小</button>
                <button id="modalDownloadDiagramBtn"><i class="fas fa-download"></i> 下载 SVG</button>
            </div>
            <div class="kityminder-container" id="modalKityMinderContainer"></div>
            <div id="mermaid-modal-feedback-message"></div>
        </div>
    </div>

    <script>
    // --- KityMinder JavaScript START ---
    // --- Global Variables ---
    let mainKM, modalKM;
    const kityminderData = { // MODIFIED: Cleared example data
        root: {
            data: { text: "核心概念", expandState: "expand" }, // Root node
            children: [] // No children initially
        },
        template: 'default',
        theme: 'customPictureTheme',
        version: "1.4.50"
    };

    // --- DOM Elements ---
    const mainZoomInBtn = document.getElementById('zoomInBtn');
    const mainZoomOutBtn = document.getElementById('zoomOutBtn');
    const mainDownloadDiagramBtn = document.getElementById('downloadDiagramBtn');
    const mainKityMinderContainer = document.getElementById('mainKityMinderContainer');
    const mermaidMainFeedbackMessage = document.getElementById('mermaid-main-feedback-message');

    const fullscreenOpenBtn = document.getElementById('fullscreenOpenBtn');
    const fullscreenModal = document.getElementById('fullscreenModal');
    const fullscreenCloseBtn = document.getElementById('fullscreenCloseBtn');
    const modalKityMinderContainer = document.getElementById('modalKityMinderContainer');
    const modalZoomInBtn = document.getElementById('modalZoomInBtn');
    const modalZoomOutBtn = document.getElementById('modalZoomOutBtn');
    const modalDownloadDiagramBtn = document.getElementById('modalDownloadDiagramBtn');
    const mermaidModalFeedbackMessage = document.getElementById('mermaid-modal-feedback-message');

    // --- KityMinder Custom Theme Definition ---
    if (typeof kityminder !== 'undefined' && kityminder.Theme) {
        kityminder.Theme.register('customPictureTheme', {
            'root-color': 'var(--km-root-text, #333333)',
            'root-background': 'var(--km-root-bg, #f0f0f0)',
            'root-stroke': 'var(--km-root-bg)',
            'root-font-size': 19,
            'root-font-weight': 'bold',
            'root-padding': [14, 24],
            'root-margin': [10, 2],
            'root-radius': 5,
            'root-space': 8,
            'root-stroke-width': 1,

            'main-color': 'var(--km-node-text, #ffffff)',
            'main-background': 'var(--km-orange)',
            'main-stroke': 'var(--km-orange)',
            'main-font-size': 19,
            'main-font-weight': 'bold',
            'main-padding': [10, 20],
            'main-margin': [10, 2],
            'main-radius': 5,
            'main-space': 4,
            'main-stroke-width': 1,

            'sub-color': 'var(--km-node-text, #ffffff)',
            'sub-background': 'var(--km-blue)',
            'sub-stroke': 'var(--km-blue)',
            'sub-font-size': 19,
            'sub-font-weight': 'bold',
            'sub-padding': [8, 16],
            'sub-margin': [8, 15],
            'sub-radius': 5,
            'sub-space': 4,
            'sub-stroke-width': 1,

            'connect-color': 'var(--km-connect-color, #777777)',
            'connect-width': 1.5,
            'main-connect-width': 1.5,
            'selected-connect-color': 'var(--km-orange)',
            'selected-connect-width': 2.5,

            'background': "#ffffff",
            'text-selection-color': 'var(--km-blue)',
            'node-padding': [6, 12],
            'node-margin': [8, 15],
            'node-radius': 5,
            'font-size': 19,
            'font-weight': 'bold',
        });
        console.log("KityMinder Debug: Custom theme 'customPictureTheme' registered.");
    } else {
        console.error("KityMinder Debug: kityminder or kityminder.Theme is not defined. Cannot register custom theme.");
    }

    // --- Helper Functions for KityMinder ---
    function showKityMinderFeedback(element, message, type = 'info', duration = 3000) {
        if (element) {
            element.textContent = message; element.className = type; element.style.display = 'block';
            setTimeout(() => { element.textContent = ''; element.className = ''; element.style.display = 'none'; }, duration);
        }
    }

    async function downloadKityMinderAsSVG(kmInstance, baseFilename, feedbackElem) {
        if (!kmInstance || typeof kmInstance.exportData !== 'function' || !kmInstance.getRoot || !kmInstance.getRoot()) {
            showKityMinderFeedback(feedbackElem, '无法下载：思维导图实例无效或内容为空。', 'error');
            return;
        }
        try {
            if (typeof kmInstance.refresh === 'function') {
                kmInstance.refresh();
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            const svgExportPromise = kmInstance.exportData('svg');
            if (!svgExportPromise || typeof svgExportPromise.then !== 'function') {
                showKityMinderFeedback(feedbackElem, '下载失败：导出函数行为异常。', 'error');
                return;
            }
            const exportedObject = await svgExportPromise;
            let svgString = "";
            if (typeof exportedObject === 'string') { svgString = exportedObject; }
            else if (exportedObject && typeof exportedObject.data === 'string') { svgString = exportedObject.data; }
            else {
                const paper = kmInstance.getPaper && kmInstance.getPaper();
                const svgNode = paper && paper.container && paper.container.firstChild;
                if (svgNode && typeof XMLSerializer !== 'undefined') {
                    svgString = new XMLSerializer().serializeToString(svgNode);
                }
            }
            if (svgString && svgString.length > 100) { // Basic check for non-empty SVG
                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = `${baseFilename}.svg`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showKityMinderFeedback(feedbackElem, `${baseFilename}.svg 已下载!`, 'success');
            } else {
                showKityMinderFeedback(feedbackElem, `下载失败：生成的SVG内容为空或无效。请确保导图已正确渲染。`, 'error');
            }
        } catch (error) {
            showKityMinderFeedback(feedbackElem, `下载 ${baseFilename}.svg 失败: ${error.message || error}`, 'error');
        }
    }

    async function initializeKityMinder(containerElement, data, feedbackElem, isModal = false) {
        console.log("Initializing KityMinder in container:", containerElement.id);
        containerElement.innerHTML = ''; // Clear previous content
         if (typeof kityminder === 'undefined' || typeof kityminder.Minder === 'undefined') {
            showKityMinderFeedback(feedbackElem, "KityMinder库未加载!", 'error');
            return null;
        }
        try {
            const km = new kityminder.Minder({ renderTo: containerElement });
            km.importJson(data);
            km.enable();

            await new Promise(resolve => setTimeout(resolve, 500)); // Allow rendering time

            if (km.getRoot && km.getRoot()) {
                km.getRoot().traverse(function(node) {
                    node.setData('font-weight', 'bold');
                    node.setData('font-size', 19);
                    node.setData('stroke-width', 1);

                    if (node.getLevel() === 0) { // Root node
                        node.setData('stroke', 'var(--km-root-bg)');
                        node.setData('padding', [14, 24]);
                    } else if (node.getLevel() === 1) { // 1st level children
                         node.setData('stroke', 'var(--km-orange)');
                         node.setData('padding', [10, 20]);
                    } else if (node.getLevel() === 2) { // 2nd level children
                         node.setData('stroke', 'var(--km-blue)');
                         node.setData('padding', [8, 16]);
                    } else if (node.getLevel() >= 3) { // Apply to 3rd level and deeper
                        node.setData('background', 'var(--km-lightblue)');
                        node.setData('color', 'var(--km-node-text, #ffffff)');
                        node.setData('padding', [8, 16]);
                        node.setData('stroke', 'var(--km-lightblue)');
                    }
                    node.render(); // Re-render node to apply changes
                });
                km.refresh(); // Refresh the entire mind map

                await new Promise(resolve => setTimeout(resolve, 100)); // Short delay after refresh

                // Adaptive view adjustment logic
                try {
                    const paper = km.getPaper();
                    const renderContainer = km.getRenderContainer();

                    if (!paper || !renderContainer) {
                        console.error("KityMinder paper or render container not available for adaptive display.");
                        km.execCommand('camera', km.getRoot(), 100); // Center root
                        km.execCommand('zoom', isModal ? 85 : 75); // Default zoom
                        return km; // Return instance even if adaptive view fails
                    }

                    const diagramBox = renderContainer.getBoundaryBox();

                    if (diagramBox && diagramBox.width > 0 && diagramBox.height > 0 &&
                        isFinite(diagramBox.x) && isFinite(diagramBox.y) &&
                        isFinite(diagramBox.width) && isFinite(diagramBox.height)) {

                        const viewPadding = 2; // Minimal padding
                        const containerWidth = containerElement.clientWidth;
                        const containerHeight = containerElement.clientHeight;

                        if (containerWidth <= 0 || containerHeight <= 0) {
                            console.warn("KityMinder Debug: Container has no dimensions yet for adaptive zoom. Falling back.");
                            km.execCommand('camera', km.getRoot(), 100);
                            km.execCommand('zoom', isModal ? 85 : 75);
                            return km;
                        }

                        const usableWidth = containerWidth - 2 * viewPadding;
                        const usableHeight = containerHeight - 2 * viewPadding;

                        const scaleX = usableWidth / diagramBox.width;
                        const scaleY = usableHeight / diagramBox.height;
                        let targetScale = Math.min(scaleX, scaleY);

                        const PADDED_ZOOM_FACTOR = 0.995; // Very close to 1
                        targetScale *= PADDED_ZOOM_FACTOR;

                        const MIN_ZOOM_PERCENT = 20;
                        const MAX_ZOOM_PERCENT = 100; // Do not zoom in beyond 100%

                        let finalZoomPercent = targetScale * 100;
                        finalZoomPercent = Math.max(MIN_ZOOM_PERCENT, finalZoomPercent);
                        finalZoomPercent = Math.min(finalZoomPercent, MAX_ZOOM_PERCENT);

                        const diagramCenterX = diagramBox.x + diagramBox.width / 2;
                        const diagramCenterY = diagramBox.y + diagramBox.height / 2;
                        const diagramCenterPoint = new kity.Point(diagramCenterX, diagramCenterY);

                        km.execCommand('zoom', finalZoomPercent, diagramCenterPoint);

                        // Dynamically adjust container height for main mind map
                        if (!isModal) { // Only adjust height for the main container
                            const actualDiagramHeightAfterZoom = diagramBox.height * (finalZoomPercent / 100);
                            const PADDING_FOR_HEIGHT = 15; // Slightly increased padding for height
                            containerElement.style.height = Math.max(350, actualDiagramHeightAfterZoom + PADDING_FOR_HEIGHT * 2) + 'px'; // Use updated min-height from CSS
                            containerElement.style.minHeight = '0px'; // Allow dynamic height to override CSS min-height if content is larger
                        }

                    } else {
                        console.warn("KityMinder Debug: Invalid diagramBox dimensions. Falling back to default view.");
                        km.execCommand('camera', km.getRoot(), 100);
                        km.execCommand('zoom', isModal ? 80 : 70); // Slightly reduced default zoom
                    }
                } catch (e_view) {
                    console.error(`KityMinder Debug: Error during adaptive view adjustment for ${containerElement.id}:`, e_view);
                    km.execCommand('camera', km.getRoot(), 100);
                    km.execCommand('zoom', isModal ? 80 : 70); // Fallback zoom
                }

                km.refresh(); // Final refresh
            }
            console.log("KityMinder initialized and data imported for:", containerElement.id);
            return km;
        } catch (error) {
            console.error("Error initializing KityMinder for " + containerElement.id + ":", error);
            showKityMinderFeedback(feedbackElem, `初始化KityMinder失败: ${error.message}`, 'error');
            containerElement.innerHTML = `<p style="color:red; text-align:center; padding:20px;">初始化KityMinder失败: ${error.message}</p>`;
            return null;
        }
    }

    // --- Main Mindmap Logic (KityMinder) ---
    if(mainZoomInBtn) mainZoomInBtn.addEventListener('click', () => { if (mainKM) mainKM.execCommand('zoomIn'); });
    if(mainZoomOutBtn) mainZoomOutBtn.addEventListener('click', () => { if (mainKM) mainKM.execCommand('zoomOut'); });
    if(mainDownloadDiagramBtn) mainDownloadDiagramBtn.addEventListener('click', () => { downloadKityMinderAsSVG(mainKM, '核心概念关系图-主视图', mermaidMainFeedbackMessage); });

    // --- Fullscreen Modal Logic (KityMinder) ---
    if(fullscreenOpenBtn) fullscreenOpenBtn.addEventListener('click', () => {
        if(fullscreenModal) fullscreenModal.classList.add('active');
        document.body.classList.add('modal-active');
        if(modalKityMinderContainer) modalKityMinderContainer.innerHTML = ''; // Clear before re-init
        initializeKityMinder(modalKityMinderContainer, kityminderData, mermaidModalFeedbackMessage, true).then(kmInstance => modalKM = kmInstance);
    });
    if(fullscreenCloseBtn) fullscreenCloseBtn.addEventListener('click', () => {
        if(fullscreenModal) fullscreenModal.classList.remove('active');
        document.body.classList.remove('modal-active');
        if(modalKityMinderContainer) modalKityMinderContainer.innerHTML = ''; // Clear content on close
        modalKM = null; // Release instance
    });
    if(modalZoomInBtn) modalZoomInBtn.addEventListener('click', () => { if (modalKM) modalKM.execCommand('zoomIn'); });
    if(modalZoomOutBtn) modalZoomOutBtn.addEventListener('click', () => { if (modalKM) modalKM.execCommand('zoomOut'); });
    if(modalDownloadDiagramBtn) modalDownloadDiagramBtn.addEventListener('click', () => { downloadKityMinderAsSVG(modalKM, '核心概念关系图-全屏', mermaidModalFeedbackMessage); });

    // --- Initial KityMinder Setup ---
    function initializeMainKityMinderDiagram() {
        console.log("DOM fully loaded or function called. Initializing main KityMinder.");
        if (typeof kityminder !== 'undefined' && mainKityMinderContainer) { // Check if library and container exist
            initializeKityMinder(mainKityMinderContainer, kityminderData, mermaidMainFeedbackMessage, false).then(kmInstance => mainKM = kmInstance);
        } else {
            if (mermaidMainFeedbackMessage) { // Check if feedback element exists
                 showKityMinderFeedback(mermaidMainFeedbackMessage, "KityMinder库加载失败或容器未找到，无法初始化思维导图。", "error");
            }
            console.error("KityMinder library or main container not available for init.");
        }
    }
    // --- KityMinder JavaScript END ---


    // --- Report Page JavaScript START ---
    // Helper function to get CSS variable values
    function getCssVariable(variableName, defaultValue = null) {
        const value = getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        return value || defaultValue;
    }

    // Function to get the base name for the report filename
    function getReportBaseName() {
        const mainTitleElement = document.querySelector('.main-card h1');
        let reportTitle = "报告"; // Default title
        const placeholderTitle = "[主报告标题 - 例如：AI产品团日报]";

        if (mainTitleElement && mainTitleElement.textContent) {
            const currentTitle = mainTitleElement.textContent.trim();
            // Use current title if it's not empty and not the placeholder
            if (currentTitle && currentTitle !== placeholderTitle) {
                reportTitle = currentTitle;
            }
        }
        // Ensure it ends with "日报"
        if (reportTitle.endsWith("日报")) {
            reportTitle = reportTitle.substring(0, reportTitle.length - 2); // Remove "日报" if already present
        }
        return reportTitle + "日报"; // Add "日报"
    }

    // Function to get a formatted date string for the filename
    function getFormattedDateString() {
        const reportDateElement = document.querySelector('.main-card .date');
        let dateStr = "nodate"; // Default if date is not found or invalid
        const placeholderDate = "[日期 - 例如：2025年5月19日]";

        if (reportDateElement && reportDateElement.textContent) {
            const dateContent = reportDateElement.textContent.trim();
            // Check if content is not empty and not the placeholder
            if (dateContent && dateContent !== placeholderDate) {
                // Try to match YYYY年M月D日 format
                const match = dateContent.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日/);
                if (match) {
                    const year = match[1];
                    const month = match[2].padStart(2, '0'); // Ensure two digits for month
                    const day = match[3].padStart(2, '0');   // Ensure two digits for day
                    dateStr = `${year}-${month}-${day}`;
                } else {
                    console.warn("Date content in .main-card .date element ('" + dateContent + "') does not match 'YYYY年M月D日' format. Using 'nodate' for filename.");
                }
            } else {
                 console.warn("Date content in .main-card .date is placeholder or empty. Using 'nodate' for filename.");
            }
        } else {
            console.warn(".main-card .date element not found or has no content. Using 'nodate' for filename.");
        }
        return dateStr;
    }

    // Function to sanitize filenames
    function sanitizeFilename(filename) {
        // Allow Chinese characters, alphanumeric, underscore, hyphen, period. Replace others with underscore.
        return filename.replace(/[^\w\u4e00-\u9fa5\-\.]/g, '_').replace(/_+/g, '_');
    }

    // Placeholder URL for "View Previous Report" button
    const previousReportUrl = "在此处填写昨日日报的URL"; // IMPORTANT: Update this URL

    // Function to show feedback messages to the user
    function showReportFeedbackMessage(message, type = 'info', duration = 3000) {
        const feedbackElement = document.getElementById('feedback-message');
        if (feedbackElement) {
            feedbackElement.textContent = message;
            feedbackElement.className = type; // Apply 'success' or 'error' class for styling
            setTimeout(() => {
                feedbackElement.textContent = '';
                feedbackElement.className = '';
            }, duration);
        }
    }

    // Screenshot function using html2canvas
    async function captureScreenshot(elementToCapture) {
        await document.fonts.ready; // Ensure fonts are loaded before capture
        return html2canvas(elementToCapture, {
            useCORS: true, // Enable cross-origin images if any
            scale: window.devicePixelRatio || 1, // Use device pixel ratio for better quality
            logging: false, // Disable html2canvas logging
            backgroundColor: getCssVariable('--bg-primary', '#f5f4ee'), // Use page background color
            scrollX: -window.scrollX, // Account for page scroll
            scrollY: -window.scrollY,
            windowWidth: document.documentElement.scrollWidth, // Capture full width
            windowHeight: document.documentElement.scrollHeight, // Capture full height
            onclone: function(clonedDoc) {
                // Fix for highlight-keyword style issue in html2canvas
                const highlightElements = clonedDoc.querySelectorAll('.highlight-keyword');
                highlightElements.forEach(el => {
                    el.style.display = 'inline';
                    el.style.padding = '1px 2px'; // Minimal padding
                    el.style.lineHeight = '1.2';
                    el.style.boxDecorationBreak = 'clone'; // Ensures background applies correctly across line breaks
                    el.style.webkitBoxDecorationBreak = 'clone';
                });
            }
        });
    }

    // "Copy Screenshot" button event listener
    const screenshotToClipboardBtn = document.getElementById('screenshotToClipboardBtn');
    if(screenshotToClipboardBtn) screenshotToClipboardBtn.addEventListener('click', async function() {
        const reportContent = document.getElementById('report-content-wrapper');
        if (!reportContent) {
            showReportFeedbackMessage('截图错误: 未找到报告内容。', 'error');
            return;
        }
        const actionButtons = document.querySelector('.action-buttons-container');
        const feedbackMsgElement = document.getElementById('feedback-message');
        const originalButtonText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
        this.disabled = true;
        if(actionButtons) actionButtons.style.visibility = 'hidden'; // Hide buttons during capture
        if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'hidden'; // Hide feedback during capture

        try {
            const canvas = await captureScreenshot(reportContent);
            canvas.toBlob(async function(blob) {
                if (blob) {
                    try {
                        if (navigator.clipboard && navigator.clipboard.write) { // Modern clipboard API
                            await navigator.clipboard.write([
                                new ClipboardItem({ 'image/png': blob })
                            ]);
                            showReportFeedbackMessage('截图已拷贝到剪贴板!', 'success');
                        } else {
                            // Fallback for browsers not supporting direct image copy to clipboard
                            const dataUrl = canvas.toDataURL('image/png');
                            const img = document.createElement('img');
                            img.src = dataUrl;
                            img.style.maxWidth = '100%';
                            img.style.border = '1px solid #ccc';

                            // Display the image in a temporary container for manual copy
                            const tempContainer = document.createElement('div');
                            tempContainer.style.position = 'fixed';
                            tempContainer.style.top = '10px';
                            tempContainer.style.left = '10px';
                            tempContainer.style.zIndex = '9999';
                            tempContainer.style.backgroundColor = 'white';
                            tempContainer.style.padding = '10px';
                            tempContainer.style.border = '1px solid black';
                            tempContainer.innerHTML = '<strong>请手动右键复制图片:</strong><br>';
                            tempContainer.appendChild(img);
                            document.body.appendChild(tempContainer);
                            showReportFeedbackMessage('截图已生成。请手动右键复制图片。此提示将在10秒后消失。', 'info', 10000);
                            setTimeout(() => { if(document.body.contains(tempContainer)) document.body.removeChild(tempContainer); }, 10000);
                        }
                    } catch (copyError) {
                        console.error('拷贝到剪贴板失败:', copyError);
                        showReportFeedbackMessage('拷贝截图到剪贴板失败: ' + copyError.message, 'error', 5000);
                    }
                } else {
                    throw new Error('无法将Canvas转换为Blob。');
                }
            }, 'image/png');
        } catch (error) {
            console.error('截图捕获失败:', error);
            showReportFeedbackMessage('截图捕获失败: ' + error.message, 'error');
        } finally {
            if(actionButtons) actionButtons.style.visibility = 'visible'; // Restore buttons
            if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'visible'; // Restore feedback
            this.innerHTML = originalButtonText;
            this.disabled = false;
        }
    });

    // "Download Screenshot" button event listener
    const screenshotDownloadBtn = document.getElementById('screenshotDownloadBtn');
    if(screenshotDownloadBtn) screenshotDownloadBtn.addEventListener('click', async function() {
        const reportContent = document.getElementById('report-content-wrapper');
        if (!reportContent) {
            showReportFeedbackMessage('截图错误: 未找到报告内容。', 'error');
            return;
        }
        const actionButtons = document.querySelector('.action-buttons-container');
        const feedbackMsgElement = document.getElementById('feedback-message');
        const originalButtonText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
        this.disabled = true;
        if(actionButtons) actionButtons.style.visibility = 'hidden';
        if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'hidden';

        try {
            const canvas = await captureScreenshot(reportContent);
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');

            const reportBaseName = getReportBaseName(); // Get base name (e.g., "AI产品团日报")
            const dateSuffix = getFormattedDateString(); // Get date (e.g., "2023-10-26")
            let filename = sanitizeFilename(reportBaseName + '-' + dateSuffix) + '.png';

            link.href = image;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showReportFeedbackMessage('截图已下载为 ' + filename + '!', 'success');
        } catch (error) {
            console.error('下载截图失败:', error);
            showReportFeedbackMessage('下载截图失败: ' + error.message, 'error');
        } finally {
            if(actionButtons) actionButtons.style.visibility = 'visible';
            if(feedbackMsgElement) feedbackMsgElement.style.visibility = 'visible';
            this.innerHTML = originalButtonText;
            this.disabled = false;
        }
    });

    // "Download Report" (HTML) button event listener
    const downloadHtmlBtn = document.getElementById('downloadHtmlBtn');
    if(downloadHtmlBtn) downloadHtmlBtn.addEventListener('click', function() {
        try {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');

            const reportBaseName = getReportBaseName();
            const dateSuffix = getFormattedDateString();
            let filename = sanitizeFilename(reportBaseName + '-' + dateSuffix) + '.html';

            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Clean up blob URL
            showReportFeedbackMessage('HTML报告已下载为 ' + filename + '!', 'success');
        } catch (error) {
            console.error('下载HTML失败:', error);
            showReportFeedbackMessage('下载HTML失败: ' + error.message, 'error');
        }
    });

    // "Copy HTML Source" button event listener
    const copyHtmlBtn = document.getElementById('copyHtmlBtn');
    if(copyHtmlBtn) copyHtmlBtn.addEventListener('click', function() {
        const htmlContent = document.documentElement.outerHTML;
        const Gthis = this; // Button's 'this' context
        const originalButtonHTML = Gthis.innerHTML; // Save original button content
        const textarea = document.createElement('textarea');
        textarea.value = htmlContent;
        textarea.style.position = 'fixed'; // Prevent display on screen
        textarea.style.top = '-9999px';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        try {
            textarea.select();
            textarea.setSelectionRange(0, textarea.value.length); // For mobile devices
            if (document.execCommand('copy')) {
                Gthis.innerHTML = '<i class="fas fa-check"></i> 已拷贝!';
                showReportFeedbackMessage('HTML已拷贝到剪贴板!', 'success', 2000);
            } else {
                Gthis.innerHTML = '<i class="fas fa-times"></i> 拷贝失败';
                showReportFeedbackMessage('拷贝失败。您的浏览器可能不支持此操作。', 'error', 2000);
            }
        } catch (err) {
            Gthis.innerHTML = '<i class="fas fa-times"></i> 拷贝出错';
            showReportFeedbackMessage('拷贝出错: ' + err.message, 'error', 2000);
            console.error('拷贝HTML源码出错:', err);
        } finally {
            setTimeout(function() { // Restore button text after a delay
                Gthis.innerHTML = originalButtonHTML;
            }, 2000);
            document.body.removeChild(textarea);
        }
    });

    // "View Previous Report" button event listener
    const viewPreviousReportBtn = document.getElementById('viewPreviousReportBtn');
    if(viewPreviousReportBtn) viewPreviousReportBtn.addEventListener('click', function() {
        const urlToOpen = previousReportUrl.trim();
        const placeholderUrlText = "在此处填写昨日日报的URL"; // Placeholder text
        if (urlToOpen && urlToOpen !== placeholderUrlText && (urlToOpen.startsWith('http://') || urlToOpen.startsWith('https://') || !urlToOpen.includes('://'))) {
            let finalUrl = urlToOpen;
            // No need to prepend http if it's a relative path or already has a protocol
            const newWindow = window.open(finalUrl, '_blank'); // Open in a new tab
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                // This might happen if a popup blocker is active
                showReportFeedbackMessage('无法打开新窗口。请检查您的弹出窗口拦截设置。', 'error', 5000);
            }
        } else {
            showReportFeedbackMessage('昨日日报的URL未配置或无效。请检查脚本中的 previousReportUrl 变量，并确保它是一个有效的网址或相对路径。', 'error', 5000);
        }
    });

    // Adjust action buttons layout based on window size
    function adjustActionButtonsLayout() {
        const actionButtonsContainer = document.querySelector('.action-buttons-container');
        if (actionButtonsContainer) {
            if (window.innerWidth <= 768) { // Corresponds to @media (max-width: 768px)
                actionButtonsContainer.style.display = 'flex';
                actionButtonsContainer.style.flexWrap = 'wrap';
                actionButtonsContainer.style.justifyContent = 'center';
            } else { // Desktop layout
                actionButtonsContainer.style.display = 'block'; // Default block display
                actionButtonsContainer.style.flexWrap = 'nowrap'; // Reset flex properties
            }
        }
    }

    // --- Event Listeners Call on Load ---
    window.addEventListener('load', () => {
        initializeMainKityMinderDiagram(); // Initialize the main mind map
        adjustActionButtonsLayout(); // Adjust button layout on load
    });
    window.addEventListener('resize', adjustActionButtonsLayout); // Adjust on resize

    // --- Report Page JavaScript END ---
</script>
</body>
</html>